<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAFT ã‚¯ã‚¨ã‚¹ãƒˆãƒãƒƒãƒ— - å†’é™ºã®æ›¸</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        body {
            font-family: 'DotGothic16', 'M PLUS Rounded 1c', sans-serif;
            line-height: 1.6;
            color: #2c2c2c;
            overflow-x: hidden;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 50%, #B0E0E6 100%);
            min-height: 100vh;
            position: relative;
            padding-bottom: 100px; /* å›ºå®šãƒœã‚¿ãƒ³åˆ†ã®ä½™ç™½ */
        }
        
        /* --- â–¼ èƒŒæ™¯æ¼”å‡ºè¿½åŠ  --- */
        .sky-object {
            position: fixed;
            opacity: 0.7;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            z-index: 1; /* ä»–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚ˆã‚Šå¾Œã‚ */
        }

        .cloud {
            width: 100px;
            height: 40px;
            background: white;
            border-radius: 100px;
            box-shadow: 
                20px 10px 0 10px white,
                -20px 10px 0 5px white;
        }
        .ufo {
            width: 60px;
            height: 30px; /* UFOã®å½¢çŠ¶ã«åˆã‚ã›ã¦èª¿æ•´ */
            /* background: radial-gradient(circle, #silver 20%, #gray 80%); */
            /* border-radius: 50% / 70% 70% 30% 30%; */
            /* box-shadow: 0 2px 5px rgba(0,0,0,0.3); */
            font-size: 40px; /* çµµæ–‡å­—ã§è¡¨ç¾ã™ã‚‹å ´åˆ */
            text-align: center;
        }
        .ufo::before {
            content: 'ğŸ›¸';
        }
        /* --- â–² èƒŒæ™¯æ¼”å‡ºè¿½åŠ  --- */
        
        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .hamburger {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1100; /* ã‚µã‚¤ãƒ‰ãƒŠãƒ“ã‚ˆã‚Šæ‰‹å‰ */
            width: 48px;
            height: 48px;
            background: #8B4513;
            border: 3px solid #654321;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 6px;
            transition: transform 0.1s ease;
            box-shadow: 
                0 0 0 1px #A0522D,
                3px 3px 0 0 rgba(0,0,0,0.3);
        }
        /* (ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
        .hamburger:hover {
            transform: translate(-1px, -1px);
            box-shadow: 
                0 0 0 1px #A0522D,
                4px 4px 0 0 rgba(0,0,0,0.3);
        }
        
        .hamburger:active {
            transform: translate(1px, 1px);
            box-shadow: 
                0 0 0 1px #A0522D,
                2px 2px 0 0 rgba(0,0,0,0.3);
        }
        
        .hamburger span {
            width: 24px;
            height: 4px;
            background: #F5DEB3;
            border-radius: 0;
            transition: all 0.3s ease;
        }
        
        /* ã‚µã‚¤ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .side-nav {
            position: fixed;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100vh;
            background: #2C1810;
            border-right: 4px solid #654321;
            z-index: 1099; /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ã‚ˆã‚Šå¥¥ã€ä»–ã‚ˆã‚Šæ‰‹å‰ */
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            padding: 80px 20px 20px;
        }
        /* (ã‚µã‚¤ãƒ‰ãƒŠãƒ“ã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
        @media (min-width: 768px) {
            .side-nav {
                width: 280px;
            }
        }
        
        .side-nav.active {
            left: 0;
        }
        
        .side-nav-item {
            padding: 16px 20px;
            margin: 8px 0;
            background: #3D2817;
            border: 2px solid #654321;
            cursor: pointer;
            transition: all 0.1s ease;
            font-weight: 500;
            color: #F5DEB3;
            text-align: center;
            position: relative;
            box-shadow: 2px 2px 0 0 rgba(0,0,0,0.5);
        }
        
        .side-nav-item:hover {
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 0 rgba(0,0,0,0.5);
            background: #4D3827;
        }
        
        .side-nav-item:active {
            transform: translate(0, 0);
            box-shadow: 1px 1px 0 0 rgba(0,0,0,0.5);
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 80px 16px 40px; /* ä¸‹éƒ¨ãƒœã‚¿ãƒ³åˆ†ã®paddingã¯bodyå´ã§èª¿æ•´ */
            position: relative;
            z-index: 10;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .map-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        /* (ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
         .map-header h1 {
            font-size: 2.5rem;
            color: #FFF;
            margin-bottom: 16px;
            text-shadow: 
                2px 2px 0 #4DB6F7,
                4px 4px 0 #3A8BC4,
                6px 6px 8px rgba(0,0,0,0.3);
            letter-spacing: 2px;
            animation: float_title 3s ease-in-out infinite; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åå¤‰æ›´ */
        }
        
        @keyframes float_title { /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åå¤‰æ›´ */
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .map-header p {
            font-size: 1.1rem;
            color: #FFF;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.2);
            display: inline-block;
            padding: 4px 16px;
            border-radius: 0;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        /* å†’é™ºã®è¨˜éŒ²ãƒœã‚¿ãƒ³ */
        .adventure-log-button {
            display: inline-block;
            margin: 20px auto 0;
            padding: 12px 32px;
            background: #FFD700;
            border: 3px solid #B8860B;
            color: #654321;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            position: relative;
            box-shadow: 
                0 0 0 1px #DAA520,
                4px 4px 0 0 rgba(0,0,0,0.3);
            transition: all 0.1s ease;
        }
        
        .adventure-log-button::before {
            content: 'ğŸ“–';
            margin-right: 8px;
        }
        
        .adventure-log-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 
                0 0 0 1px #DAA520,
                6px 6px 0 0 rgba(0,0,0,0.3);
        }
        
        .adventure-log-button:active {
            transform: translate(1px, 1px);
            box-shadow: 
                0 0 0 1px #DAA520,
                2px 2px 0 0 rgba(0,0,0,0.3);
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸ã‚°ãƒªãƒƒãƒ‰ */
        .stage-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 32px;
            margin-bottom: 40px;
            padding: 0 20px;
        }
        /* (ã‚¹ãƒ†ãƒ¼ã‚¸ã‚°ãƒªãƒƒãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
         @media (max-width: 767px) {
            .stage-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 24px;
                padding: 0;
            }
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸ãƒãƒ¼ãƒ‰ */
        .stage-node {
            position: relative;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        /* (ã‚¹ãƒ†ãƒ¼ã‚¸ãƒãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
        .stage-node:nth-child(2),
        .stage-node:nth-child(5) {
            transform: translateY(40px);
        }
        
        @media (max-width: 767px) {
            .stage-node:nth-child(even) {
                transform: translateY(40px);
            }
            .stage-node:nth-child(5) {
                transform: translateY(0);
            }
        }
        
        .stage-node:hover {
            transform: translateY(-5px) scale(1.05);
        }
        
        .stage-node:nth-child(2):hover,
        .stage-node:nth-child(5):hover {
            transform: translateY(35px) scale(1.05);
        }
        
        @media (max-width: 767px) {
            .stage-node:nth-child(even):hover {
                transform: translateY(35px) scale(1.05);
            }
            .stage-node:nth-child(5):hover {
                transform: translateY(-5px) scale(1.05);
            }
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¢ã‚¤ã‚³ãƒ³ */
        .stage-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 16px;
            position: relative;
            background: #E8F5E9; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®èƒŒæ™¯è‰² */
            border: 4px solid #333;
            box-shadow: 
                0 0 0 2px #666,
                6px 6px 0 0 rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .stage-node.locked .stage-icon,
        .stage-node.current .stage-icon { /* currentã‚‚ã‚¯ãƒªã‚¢å‰ãªã®ã§ã‚°ãƒ¬ãƒ¼ */
            background: #9E9E9E; /* ãƒ­ãƒƒã‚¯ä¸­ãƒ»æŒ‘æˆ¦ä¸­ã®èƒŒæ™¯è‰² */
        }
        .stage-node.completed .stage-icon {
            background: #FFF9C4; /* ã‚¯ãƒªã‚¢å¾Œã®èƒŒæ™¯è‰² */
            box-shadow: 
                0 0 0 2px #FFD700,
                6px 6px 0 0 rgba(0,0,0,0.3),
                0 0 20px rgba(255,215,0,0.5);
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒ */
        .stage-icon img.icon-image {
            width: 64px;
            height: 64px;
            object-fit: contain;
            image-rendering: pixelated;
            display: block;
            transition: filter 0.3s ease; /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰åŒ–ã‚’æ»‘ã‚‰ã‹ã« */
            filter: grayscale(1); /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚°ãƒ¬ãƒ¼ */
        }
        .stage-node.completed .stage-icon img.icon-image {
            filter: grayscale(0); /* ã‚¯ãƒªã‚¢ã—ãŸã‚‰ã‚«ãƒ©ãƒ¼ã« */
        }
        .stage-node.locked .stage-icon img.icon-image { /* lockedã‚¯ãƒ©ã‚¹ã§æ˜ç¤ºçš„ã«ã‚°ãƒ¬ãƒ¼ */
             filter: grayscale(1);
             opacity: 0.7;
        }

        .stage-icon .icon-fallback {
            font-size: 64px;
            display: none;
            filter: grayscale(1); /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚°ãƒ¬ãƒ¼ */
        }
        .stage-node.completed .stage-icon .icon-fallback {
            filter: grayscale(0); /* ã‚¯ãƒªã‚¢ã—ãŸã‚‰ã‚«ãƒ©ãƒ¼ã« */
        }
        .stage-node.locked .stage-icon .icon-fallback {
             filter: grayscale(1);
             opacity: 0.7;
        }
        
        /* ã‚¯ãƒªã‚¢æ¼”å‡ºç”»åƒ */
        .clear-effect {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            object-fit: contain;
            display: none;
            z-index: 2;
            animation: effect-animation 2s ease-in-out infinite;
        }
        /* (ã‚¯ãƒªã‚¢æ¼”å‡ºã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
        .stage-node.completed .clear-effect {
            display: block;
        }
        
        @keyframes effect-animation { /*æ±ç”¨çš„ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹*/
            0%, 100% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0.9; }
            25% { transform: translateY(-5px) scale(1.1) rotate(5deg); opacity: 1; }
            50% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0.9; }
            75% { transform: translateY(-3px) scale(1.05) rotate(-5deg); opacity: 1; }
        }
        
        /* CLEARãƒãƒƒã‚¸ */
        .clear-badge {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: #FFD700;
            border: 3px solid #B8860B;
            padding: 4px 12px;
            font-weight: bold;
            font-size: 14px;
            color: #654321;
            letter-spacing: 1px;
            box-shadow: 
                0 0 0 1px #DAA520,
                3px 3px 0 0 rgba(0,0,0,0.5);
            z-index: 10;
            animation: bounce-in 0.5s ease;
            display: none;
        }
        /* (CLEARãƒãƒƒã‚¸ã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
        .stage-node.completed .clear-badge {
            display: block;
        }
        
        @keyframes bounce-in {
            0% { transform: translateX(-50%) translateY(-20px) scale(0); }
            50% { transform: translateX(-50%) translateY(0) scale(1.2); }
            100% { transform: translateX(-50%) translateY(0) scale(1); }
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸ç•ªå·ãƒãƒƒã‚¸ */
        .stage-number-badge {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: #4DB6F7;
            border: 3px solid #2C88C7;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 12px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            box-shadow: 
                0 0 0 1px #5AC8F7,
                3px 3px 0 0 rgba(0,0,0,0.3);
            z-index: 5;
        }
        /* (ã‚¹ãƒ†ãƒ¼ã‚¸ç•ªå·ãƒãƒƒã‚¸ã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
         .stage-node.locked .stage-number-badge {
            background: #757575;
            border-color: #616161;
            box-shadow: 
                0 0 0 1px #9E9E9E,
                3px 3px 0 0 rgba(0,0,0,0.3);
        }
        
        /* ä¸»äººå…¬ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ */
        .hero-character {
            position: absolute;
            top: -60px; /* ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸Šã«è¡¨ç¤º */
            left: 50%;
            transform: translateX(-50%);
            width: 48px;
            height: 48px;
            z-index: 20; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ */
            animation: hero-idle 0.8s steps(2) infinite;
            display: none;
        }
        /* (ä¸»äººå…¬ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
        .stage-node.current .hero-character {
            display: block;
        }
        
        @keyframes hero-idle {
            0% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-2px); }
        }
        
        /* ä¸»äººå…¬ã®è¦‹ãŸç›® */
        .hero-sprite {
            width: 100%;
            height: 100%;
            background-size: 48px 48px;
            image-rendering: pixelated;
        }
        /* (ä¸»äººå…¬ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
        .hero-level-1 {
            background: 
                linear-gradient(to right, transparent 45%, #8B4513 45%, #8B4513 55%, transparent 55%),
                linear-gradient(to bottom, #F4A460 0%, #F4A460 30%, #4169E1 30%, #4169E1 70%, #8B4513 70%);
        }
        
        .hero-level-2 {
            background: 
                linear-gradient(to bottom, #FF0000 0%, #FF0000 15%, transparent 15%),
                linear-gradient(to right, transparent 45%, #8B4513 45%, #8B4513 55%, transparent 55%),
                linear-gradient(to bottom, #F4A460 15%, #F4A460 35%, #4169E1 35%, #4169E1 70%, #8B4513 70%);
        }
        
        .hero-level-3 {
            background: 
                linear-gradient(to right, transparent 70%, #C0C0C0 70%, #C0C0C0 75%, transparent 75%),
                linear-gradient(to bottom, #FF0000 0%, #FF0000 15%, transparent 15%),
                linear-gradient(to right, transparent 45%, #8B4513 45%, #8B4513 55%, transparent 55%),
                linear-gradient(to bottom, #F4A460 15%, #F4A460 35%, #32CD32 35%, #32CD32 70%, #8B4513 70%);
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ± */
        .stage-info {
            background: white;
            border: 3px solid #333;
            padding: 12px 16px;
            margin-top: 16px;
            position: relative;
            box-shadow: 
                0 0 0 1px #666,
                4px 4px 0 0 rgba(0,0,0,0.2);
        }
        /* (ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ±ã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
        .stage-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        
        .stage-description {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }
        
        /* ãƒ‘ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆé“ï¼‰ */
        .path-line {
            position: absolute;
            width: 60px;
            height: 4px;
            background: repeating-linear-gradient(
                90deg,
                #8B4513,
                #8B4513 10px,
                #D2691E 10px,
                #D2691E 20px
            );
            top: 60px; /* .stage-icon ã®ä¸­å¿ƒã‚ãŸã‚Š (120px / 2) */
            right: -60px;
            transform: translateY(-50%);
            z-index: 1;
        }
        /* (ãƒ‘ã‚¹ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
        .stage-node:nth-child(3n) .path-line,
        .stage-node:last-child .path-line {
            display: none;
        }
        
        @media (max-width: 767px) {
            .stage-node:nth-child(3n) .path-line { display: block; }
            .stage-node:nth-child(2n) .path-line,
            .stage-node:last-child .path-line {
                display: none;
            }
        }
        
        /* --- â–¼ ã‚¯ã‚¨ã‚¹ãƒˆãƒœã‚¿ãƒ³ä½ç½®å¤‰æ›´ --- */
        .quest-button {
            position: fixed; /* å³ä¸‹ã«å›ºå®š */
            bottom: 30px;
            right: 30px;
            width: auto; /* width: fit-content; ã¯ä¸€éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§è§£é‡ˆãŒç•°ãªã‚‹ãŸã‚autoã« */
            min-width: 200px; /* æœ€ä½å¹… */
            margin: 0; /* autoãƒãƒ¼ã‚¸ãƒ³è§£é™¤ */
            padding: 16px 32px; /* å°‘ã—å°ã•ã */
            background: #FF6B6B;
            border: 4px solid #DC143C;
            color: white;
            font-size: 1.2rem; /* å°‘ã—å°ã•ã */
            font-weight: bold;
            cursor: pointer;
            box-shadow: 
                0 0 0 2px #FF8787,
                6px 6px 0 0 rgba(0,0,0,0.3);
            transition: all 0.1s ease;
            animation: pulse_button 2s ease-in-out infinite; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åå¤‰æ›´ */
            z-index: 900; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ */
        }
        
        @keyframes pulse_button { /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åå¤‰æ›´ */
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .quest-button:hover {
            transform: translate(-2px, -2px) scale(1.02); /* ãƒ›ãƒãƒ¼æ™‚ã‚‚å°‘ã—å¤§ãã */
            box-shadow: 
                0 0 0 2px #FF8787,
                8px 8px 0 0 rgba(0,0,0,0.3);
            animation: none;
        }
        
        .quest-button:active {
            transform: translate(2px, 2px);
            box-shadow: 
                0 0 0 2px #FF8787,
                2px 2px 0 0 rgba(0,0,0,0.3);
        }
        @media (max-width: 767px) {
            .quest-button {
                padding: 12px 24px;
                font-size: 1rem;
                bottom: 20px;
                right: 20px;
                min-width: 160px;
            }
        }
        /* --- â–² ã‚¯ã‚¨ã‚¹ãƒˆãƒœã‚¿ãƒ³ä½ç½®å¤‰æ›´ --- */
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        /* (ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
         .modal-content {
            background: #F5F5DC;
            border: 4px solid #8B4513;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 
                0 0 0 2px #A0522D,
                8px 8px 0 0 rgba(0,0,0,0.5);
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: #DC143C;
            border: 2px solid #8B0000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            font-weight: bold;
            box-shadow: 2px 2px 0 0 rgba(0,0,0,0.5);
        }
        
        .modal-close:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 0 rgba(0,0,0,0.5);
        }
        
        .modal-close:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 0 rgba(0,0,0,0.5);
        }
        
        .modal-title {
            font-size: 1.6rem;
            color: #8B4513;
            margin-bottom: 16px;
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
        }
        
        .modal-description {
            color: #654321;
            margin-bottom: 20px;
            line-height: 1.6;
            text-align: center;
        }
        
        .modal-message {
            background: #FFF9C4;
            border: 2px solid #F9A825;
            padding: 16px;
            margin-bottom: 24px;
            text-align: center;
            font-style: italic;
            color: #5D4037;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.1);
        }
        
        .modal-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
        }
        
        @media (max-width: 767px) {
            .modal-buttons {
                flex-direction: column;
            }
        }
        
        .modal-button {
            flex: 1;
            padding: 12px 24px;
            border: 3px solid;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s ease;
            position: relative;
        }
        
        .modal-button.video {
            background: #4CAF50;
            border-color: #388E3C;
            color: white;
            box-shadow: 
                0 0 0 1px #66BB6A,
                4px 4px 0 0 rgba(0,0,0,0.3);
        }
        
        .modal-button.video:hover {
            transform: translate(-2px, -2px);
            box-shadow: 
                0 0 0 1px #66BB6A,
                6px 6px 0 0 rgba(0,0,0,0.3);
        }
        
        .modal-button.quest {
            background: #2196F3;
            border-color: #1976D2;
            color: white;
            box-shadow: 
                0 0 0 1px #42A5F5,
                4px 4px 0 0 rgba(0,0,0,0.3);
        }
        
        .modal-button.quest:hover {
            transform: translate(-2px, -2px);
            box-shadow: 
                0 0 0 1px #42A5F5,
                6px 6px 0 0 rgba(0,0,0,0.3);
        }
        
        .modal-button:active {
            transform: translate(1px, 1px);
            box-shadow: 
                0 0 0 1px currentColor, 
                2px 2px 0 0 rgba(0,0,0,0.3);
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        /* (ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«çœç•¥) */
        .loading-content {
            text-align: center;
            background: #F5F5DC;
            padding: 30px;
            border: 4px solid #8B4513;
            box-shadow: 
                0 0 0 2px #A0522D,
                8px 8px 0 0 rgba(0,0,0,0.5);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4DB6F7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-content p {
            color: #654321;
            font-weight: bold;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
    <!-- â–¼ èƒŒæ™¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="skyObjectsContainer"></div>
    <!-- â–² èƒŒæ™¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>å†’é™ºã®æº–å‚™ä¸­...</p>
        </div>
    </div>
    
    <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
    </div>
    
    <!-- ã‚µã‚¤ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="side-nav" id="sideNav">
        <div class="side-nav-item">ğŸ  ãƒ›ãƒ¼ãƒ </div>
        <div class="side-nav-item">âš”ï¸ ã‚¸ãƒ–ãƒ³ã‚¯ãƒ©ãƒ•ãƒˆ</div>
        <div class="side-nav-item">ğŸ—ºï¸ ã‚¯ã‚¨ã‚¹ãƒˆ</div>
        <div class="side-nav-item">ğŸŒ Yononaka</div>
        <div class="side-nav-item">ğŸš€ ãƒŸãƒ©ã‚¤ã‚¯ãƒ©ãƒ•ãƒˆ</div>
    </nav>
    
    <div class="container">
        <header class="map-header">
            <h1>ğŸ—ºï¸ CLAFT ã‚¯ã‚¨ã‚¹ãƒˆãƒãƒƒãƒ—</h1>
            <p>ãã¿ã ã‘ã®å†’é™ºç‰©èªã‚’ã¤ãã‚ã†ï¼</p>
            <button class="adventure-log-button" id="adventureLogBtn">
                ã“ã‚Œã¾ã§ã®å†’é™ºã‚’æŒ¯ã‚Šè¿”ã‚‹
            </button>
        </header>
        
        <div class="stage-grid" id="stageGrid">
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¸1 -->
            <div class="stage-node" id="stage-1" data-stage-id="1">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character">
                    <div class="hero-sprite hero-level-1"></div>
                </div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/8B4513/FFFFFF?text=House" alt="ã‚¹ãƒ†ãƒ¼ã‚¸1ã‚¢ã‚¤ã‚³ãƒ³" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">ğŸ </span>
                    <img class="clear-effect" src="https://via.placeholder.com/32x32/CCCCCC/000000?text=Smoke" alt="ç…™ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ" data-effect-type="smoke">
                </div>
                <div class="stage-number-badge">1</div>
                <div class="stage-info">
                    <h3 class="stage-title"></h3>
                    <p class="stage-description"></p>
                </div>
                <div class="path-line"></div>
            </div>
            
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¸2 ã‹ã‚‰ ã‚¹ãƒ†ãƒ¼ã‚¸6 ã¾ã§åŒæ§˜ã«è¨˜è¿° -->
            <div class="stage-node" id="stage-2" data-stage-id="2">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character"><div class="hero-sprite hero-level-1"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/228B22/FFFFFF?text=Forest" alt="ã‚¹ãƒ†ãƒ¼ã‚¸2ã‚¢ã‚¤ã‚³ãƒ³" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">ğŸŒ²</span>
                    <img class="clear-effect" src="https://via.placeholder.com/32x32/8B4513/FFFFFF?text=Animal" alt="å‹•ç‰©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ" data-effect-type="animal">
                </div>
                <div class="stage-number-badge">2</div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <div class="stage-node" id="stage-3" data-stage-id="3">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character"><div class="hero-sprite hero-level-1"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/4169E1/FFFFFF?text=Sword" alt="ã‚¹ãƒ†ãƒ¼ã‚¸3ã‚¢ã‚¤ã‚³ãƒ³" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">âš”ï¸</span>
                </div>
                <div class="stage-number-badge">3</div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <div class="stage-node" id="stage-4" data-stage-id="4">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character"><div class="hero-sprite hero-level-1"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/FFD700/000000?text=Shield" alt="ã‚¹ãƒ†ãƒ¼ã‚¸4ã‚¢ã‚¤ã‚³ãƒ³" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">ğŸ›¡ï¸</span>
                </div>
                <div class="stage-number-badge">4</div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <div class="stage-node" id="stage-5" data-stage-id="5">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character"><div class="hero-sprite hero-level-1"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/32CD32/FFFFFF?text=Team" alt="ã‚¹ãƒ†ãƒ¼ã‚¸5ã‚¢ã‚¤ã‚³ãƒ³" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">ğŸ‘¥</span>
                </div>
                <div class="stage-number-badge">5</div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <div class="stage-node" id="stage-6" data-stage-id="6">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character"><div class="hero-sprite hero-level-1"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/8B0000/FFFFFF?text=Boss" alt="ã‚¹ãƒ†ãƒ¼ã‚¸6ã‚¢ã‚¤ã‚³ãƒ³" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">ğŸ°</span>
                </div>
                <div class="stage-number-badge">6</div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
            </div>
        </div>
        
        <!-- ãƒœã‚¿ãƒ³ã¯ã‚³ãƒ³ãƒ†ãƒŠã®å¤–ã«ç§»å‹•ã—ã¦ã‚‚è‰¯ã„ãŒã€ä»Šå›ã¯CSSã§å›ºå®š -->
    </div>
    
    <!-- ã€Œæ¬¡ã®å†’é™ºã¸é€²ã‚€ã€ãƒœã‚¿ãƒ³ -->
    <button class="quest-button" id="mainQuestButton">ğŸ”¥ æ¬¡ã®å†’é™ºã¸é€²ã‚€ï¼</button>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="stageModal">
        <div class="modal-content">
            <button class="modal-close" id="modalCloseBtn">Ã—</button>
            <h2 class="modal-title" id="modalStageTitle"></h2>
            <p class="modal-description" id="modalStageDescription"></p>
            <div class="modal-message" id="modalStageMessage"></div>
            <div class="modal-buttons">
                <button class="modal-button video" id="modalVideoBtn">ğŸ¬ å‹•ç”»ã‚’è¦‹ã‚‹</button>
                <button class="modal-button quest" id="modalQuestBtn">âš”ï¸ ã‚¯ã‚¨ã‚¹ãƒˆã«æŒ‘ã‚€</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š ---
        const ADALO_API_ENDPOINT = 'YOUR_ADALO_ENDPOINT/collections/YOUR_PROGRESS_COLLECTION_ID';
        const ADALO_API_KEY = 'Bearer YOUR_ADALO_API_KEY';
        const TOTAL_STAGES = 6;
        const NUM_SKY_OBJECTS = 5; // è¡¨ç¤ºã™ã‚‹ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ•°ï¼ˆé›²ï¼‹UFOï¼‰

        // (stageStaticData, DOMè¦ç´ å–å¾— ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥)
        const stageStaticData = { /* ...å‰å›åŒæ§˜... */ 
            1: { title: 'å›ã¯ã©ã‚“ãªå†’é™ºè€…ï¼Ÿ', description: 'ã“ã®ä¸–ç•Œã®åœ°å›³ã‚’ã²ã‚‰ã„ã¦ã€CLAFTã‚’å†’é™ºã—ã‚ˆã†ï¼', message: 'ã€Œã“ã®ä¸–ç•Œã‚’ã©ã†æ­©ãã‹ã¯ã€è‡ªåˆ†ã§æ±ºã‚ã¦ã„ã„ã€', iconImage: 'https://via.placeholder.com/64x64/8B4513/FFFFFF?text=House', clearEffectImage: 'https://via.placeholder.com/32x32/CCCCCC/000000?text=Smoke' },
            2: { title: 'ãƒ¯ã‚¯ã‚‚ã‚„ã‚¨ãƒãƒ«ã‚®ãƒ¼', description: 'ãƒ¯ã‚¯ãƒ¯ã‚¯ãƒ»ã‚‚ã‚„ã‚‚ã‚„ã¯å•ã„ã®åŸå‹•åŠ›ã«ãªã‚‹', message: 'ã€Œå›ã®æ„Ÿã˜ãŸ"ã‚‚ã‚„ã‚‚ã‚„"ãŒã€å†’é™ºã®å‡ºç™ºç‚¹ã€', iconImage: 'https://via.placeholder.com/64x64/228B22/FFFFFF?text=Forest', clearEffectImage: 'https://via.placeholder.com/32x32/8B4513/FFFFFF?text=Animal' },
            3: { title: 'å›ã¯ã©ã‚“ãªã‚­ãƒ£ãƒ©ï¼Ÿ', description: 'è‡ªåˆ†ã‚’è‚²ã¦ã‚‹è‚²æˆã‚²ãƒ¼ãƒ ', message: 'ã€Œè‡ªåˆ†ã®ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ã‚’è‚²ã¦ã‚‹ã®ã¯ã€å›è‡ªèº«ã ã€', iconImage: 'https://via.placeholder.com/64x64/4169E1/FFFFFF?text=Sword', clearEffectImage: null },
            4: { title: 'ã©ã‚“ãªé“å…·ã‚’æŒã£ã¦ã‚‹ï¼Ÿ', description: 'ã“ã®ä¸–ç•Œã®åœ°å›³ã‚’ã²ã‚‰ã„ã¦ã€CLAFTã‚’å†’é™ºã—ã‚ˆã†ï¼', message: 'ã€Œè‡ªåˆ†ã®ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ã‚’è‚²ã¦ã‚‹ã®ã¯ã€å›è‡ªèº«ã ã€', iconImage: 'https://via.placeholder.com/64x64/FFD700/000000?text=Shield', clearEffectImage: null },
            5: { title: 'ä»²é–“ã¨å†’é™ºã™ã‚‹ã£ã¦ï¼Ÿ', description: 'ã“ã®ä¸–ç•Œã®åœ°å›³ã‚’ã²ã‚‰ã„ã¦ã€CLAFTã‚’å†’é™ºã—ã‚ˆã†ï¼', message: 'ã€Œè‡ªåˆ†ã®ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ã‚’è‚²ã¦ã‚‹ã®ã¯ã€å›è‡ªèº«ã ã€', iconImage: 'https://via.placeholder.com/64x64/32CD32/FFFFFF?text=Team', clearEffectImage: null },
            6: { title: 'æœªæ¥ã®ãƒœã‚¹ã¨å‘ãåˆã†', description: 'ã“ã®ä¸–ç•Œã®åœ°å›³ã‚’ã²ã‚‰ã„ã¦ã€CLAFTã‚’å†’é™ºã—ã‚ˆã†ï¼', message: 'ã€Œè‡ªåˆ†ã®ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ã‚’è‚²ã¦ã‚‹ã®ã¯ã€å›è‡ªèº«ã ã€', iconImage: 'https://via.placeholder.com/64x64/8B0000/FFFFFF?text=Boss', clearEffectImage: null }
        };
        const loadingOverlay = document.getElementById('loadingOverlay');
        const stageGrid = document.getElementById('stageGrid');
        const mainQuestButton = document.getElementById('mainQuestButton');
        const stageModal = document.getElementById('stageModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalStageTitle = document.getElementById('modalStageTitle');
        const modalStageDescription = document.getElementById('modalStageDescription');
        const modalStageMessage = document.getElementById('modalStageMessage');
        const modalVideoBtn = document.getElementById('modalVideoBtn');
        const modalQuestBtn = document.getElementById('modalQuestBtn');
        const skyObjectsContainer = document.getElementById('skyObjectsContainer'); // èƒŒæ™¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”¨ã‚³ãƒ³ãƒ†ãƒŠ
        
        let currentUserId = null;
        let userProgress = {}; 
        let heroLevel = 1;
        let currentStageIdForModal = null;

        // --- â–¼ èƒŒæ™¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ ---
        function createSkyObjects() {
            for (let i = 0; i < NUM_SKY_OBJECTS; i++) {
                const obj = document.createElement('div');
                obj.classList.add('sky-object');
                
                const type = Math.random() < 0.7 ? 'cloud' : 'ufo'; // 70%é›²ã€30%UFO
                obj.classList.add(type);

                obj.style.top = `${Math.random() * 60 + 5}%`; // 5%ã‹ã‚‰65%ã®é«˜ã•ã«ãƒ©ãƒ³ãƒ€ãƒ é…ç½®
                const duration = Math.random() * 20 + 20; // 20ç§’ã‹ã‚‰40ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“
                obj.style.animationDuration = `${duration}s`;
                
                if (Math.random() < 0.5) { // å·¦ã‹ã‚‰å³ã¸
                    obj.style.left = `-${Math.random() * 100 + 100}px`; // é–‹å§‹ä½ç½®ã‚’ç”»é¢å¤–å·¦ã«
                    obj.style.animationName = 'float-sky-ltr';
                } else { // å³ã‹ã‚‰å·¦ã¸
                    obj.style.right = `-${Math.random() * 100 + 100}px`; // é–‹å§‹ä½ç½®ã‚’ç”»é¢å¤–å³ã«
                    obj.style.animationName = 'float-sky-rtl';
                }
                obj.style.animationDelay = `${Math.random() * duration}s`; // é–‹å§‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ãšã‚‰ã™

                skyObjectsContainer.appendChild(obj);
            }
        }
        // CSSã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ã‚ã‚Š
        // @keyframes float-sky-ltr { from { transform: translateX(0); } to { transform: translateX(calc(100vw + 200px)); } }
        // @keyframes float-sky-rtl { from { transform: translateX(0); } to { transform: translateX(calc(-100vw - 200px)); } }
        // (ä¸Šè¨˜ã¯CSSã§å¯¾å¿œæ¸ˆã¿ãªã‚‰ä¸è¦)
        // --- â–² èƒŒæ™¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ ---

        // (ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—ã€Adalo APIé€£æºã€ä¸»äººå…¬ãƒ¬ãƒ™ãƒ«æ›´æ–° ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥)
        function showLoading(show) { loadingOverlay.style.display = show ? 'flex' : 'none'; }
        function getUserIdFromUrl() { const params = new URLSearchParams(window.location.search); return params.get('userId'); }
        async function fetchUserProgress(userId) { /* ...å‰å›åŒæ§˜... */ 
            showLoading(true);
            console.log(`Fetching progress for userId: ${userId}`);
            return new Promise(resolve => {
                setTimeout(() => {
                    const dummyApiResponse = []; // ãƒ†ã‚¹ãƒˆç”¨
                    const progress = {};
                    if (dummyApiResponse.length === 0 && userId !== 'testUserAllClear') { // å…¨ã‚¯ãƒªã‚¢ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä»¥å¤–
                        progress[1] = 'current';
                        for (let i = 2; i <= TOTAL_STAGES; i++) {
                            progress[i] = 'locked';
                        }
                    } else if (userId === 'testUserAllClear') { // å…¨ã‚¯ãƒªã‚¢çŠ¶æ…‹ã®ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼
                         for (let i = 1; i <= TOTAL_STAGES; i++) {
                            progress[i] = 'completed';
                        }
                    }
                    else {
                         for (let i = 1; i <= TOTAL_STAGES; i++) {
                            const record = dummyApiResponse.find(r => r.stageId === i);
                            progress[i] = record ? record.status : (i === 1 ? 'current' : 'locked'); 
                        }
                    }
                    console.log('Dummy progress fetched:', progress);
                    showLoading(false);
                    resolve(progress);
                }, 1000);
            });
        }
        async function saveUserProgress(userId, stageId, newStatus) { /* ...å‰å›åŒæ§˜... */ 
            showLoading(true);
            console.log(`Saving progress for userId: ${userId}, stageId: ${stageId}, status: ${newStatus}`);
            return new Promise(resolve => {
                setTimeout(() => {
                    userProgress[stageId] = newStatus;
                    console.log('Dummy progress saved:', userProgress);
                    showLoading(false);
                    resolve(true); 
                }, 500);
            });
        }
        function updateHeroLevel() { /* ...å‰å›åŒæ§˜... */ 
            const completedCount = Object.values(userProgress).filter(status => status === 'completed').length;
            if (completedCount >= 4) heroLevel = 3;
            else if (completedCount >= 2) heroLevel = 2;
            else heroLevel = 1;
        }


        // --- ç”»é¢è¡¨ç¤ºæ›´æ–° ---
        function updateStageDisplay() {
            updateHeroLevel();
            let currentStageExists = false;
            let allStagesCompleted = true; // å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢åˆ¤å®šç”¨

            for (let i = 1; i <= TOTAL_STAGES; i++) {
                const stageNode = document.getElementById(`stage-${i}`);
                if (!stageNode) continue;

                const status = userProgress[i] || 'locked';
                stageNode.classList.remove('completed', 'current', 'locked');
                stageNode.classList.add(status);
                
                if (status !== 'completed') {
                    allStagesCompleted = false; // 1ã¤ã§ã‚‚æœªã‚¯ãƒªã‚¢ãŒã‚ã‚Œã°ãƒ•ãƒ©ã‚°ã‚’falseã«
                }

                // (ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ±ã€ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã€ã‚¯ãƒªã‚¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã€ä¸»äººå…¬è¡¨ç¤º ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥)
                 const staticInfo = stageStaticData[i];
                stageNode.querySelector('.stage-title').textContent = staticInfo.title;
                stageNode.querySelector('.stage-description').textContent = staticInfo.description;
                const iconImg = stageNode.querySelector('.stage-icon img.icon-image');
                const fallbackSpan = stageNode.querySelector('.stage-icon .icon-fallback');
                if (iconImg) {
                    iconImg.src = staticInfo.iconImage;
                    iconImg.style.display = 'block'; 
                    fallbackSpan.style.display = 'none';
                }
                const clearEffectImg = stageNode.querySelector('.clear-effect');
                if (clearEffectImg) {
                    if (status === 'completed' && staticInfo.clearEffectImage) {
                        clearEffectImg.src = staticInfo.clearEffectImage;
                        clearEffectImg.style.display = 'block';
                    } else {
                        clearEffectImg.style.display = 'none';
                    }
                }
                const heroCharacter = stageNode.querySelector('.hero-character');
                if (heroCharacter) {
                    if (status === 'current') {
                        heroCharacter.style.display = 'block';
                        heroCharacter.querySelector('.hero-sprite').className = `hero-sprite hero-level-${heroLevel}`;
                        currentStageExists = true;
                    } else {
                        heroCharacter.style.display = 'none';
                    }
                }
            }
            
            // ã€Œæ¬¡ã®å†’é™ºã¸é€²ã‚€ï¼ã€ãƒœã‚¿ãƒ³
            if (allStagesCompleted) { // å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ã®å ´åˆ
                mainQuestButton.textContent = 'ğŸ‰ å…¨ã¦ã®å†’é™ºã‚’é”æˆï¼';
                mainQuestButton.disabled = true;
            } else if (!currentStageExists) { // ç¾åœ¨åœ°ãŒãªã„ãŒã€æœªã‚¯ãƒªã‚¢ã‚¹ãƒ†ãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆï¼ˆã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ãªã©ï¼‰
                 mainQuestButton.textContent = 'â“ ç¾åœ¨åœ°ä¸æ˜';
                 mainQuestButton.disabled = true; // ã¾ãŸã¯æœ€åˆã®æœªã‚¯ãƒªã‚¢ã‚’é–‹ããªã©
            }
            else {
                mainQuestButton.textContent = 'ğŸ”¥ æ¬¡ã®å†’é™ºã¸é€²ã‚€ï¼';
                mainQuestButton.disabled = false;
            }
        }

        // (ãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç†ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥)
        function openStageModal(stageId) { /* ...å‰å›åŒæ§˜... */ 
            const status = userProgress[stageId];
            if (status === 'locked') {
                alert('ã“ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã¾ã é–‹æ”¾ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼');
                return;
            }
            currentStageIdForModal = stageId;
            const staticInfo = stageStaticData[stageId];
            modalStageTitle.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¸ ${stageId}: ${staticInfo.title}`;
            modalStageDescription.textContent = staticInfo.description;
            modalStageMessage.textContent = staticInfo.message;
            modalQuestBtn.style.display = (status === 'current') ? 'block' : 'none';
            stageModal.style.display = 'flex';
        }
        function closeStageModal() { /* ...å‰å›åŒæ§˜... */ 
            stageModal.style.display = 'none';
            currentStageIdForModal = null;
        }
        // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼
        const hamburger = document.getElementById('hamburger');
        const sideNav = document.getElementById('sideNav');
        hamburger.addEventListener('click', () => { hamburger.classList.toggle('active'); sideNav.classList.toggle('active'); });
        document.addEventListener('click', (e) => { if (sideNav.classList.contains('active') && !hamburger.contains(e.target) && !sideNav.contains(e.target)) { hamburger.classList.remove('active'); sideNav.classList.remove('active'); }});
        // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒãƒ¼ãƒ‰
        document.querySelectorAll('.stage-node').forEach(node => { node.addEventListener('click', () => { const stageId = node.dataset.stageId; openStageModal(parseInt(stageId)); }); });
        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        modalCloseBtn.addEventListener('click', closeStageModal);
        stageModal.addEventListener('click', (e) => { if (e.target === stageModal) closeStageModal(); });
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å‹•ç”»
        modalVideoBtn.addEventListener('click', () => { alert(`ã‚¹ãƒ†ãƒ¼ã‚¸ ${currentStageIdForModal} ã®å‹•ç”»ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ï¼ˆå®Ÿè£…ã¯åˆ¥é€”ï¼‰`); });
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¯ã‚¨ã‚¹ãƒˆ
        modalQuestBtn.addEventListener('click', async () => { /* ...å‰å›åŒæ§˜ã®ãƒ­ã‚¸ãƒƒã‚¯... */ 
            if (!currentStageIdForModal || userProgress[currentStageIdForModal] !== 'current') return;
            const success = await saveUserProgress(currentUserId, currentStageIdForModal, 'completed');
            if (success) {
                userProgress[currentStageIdForModal] = 'completed'; 
                const nextStageId = currentStageIdForModal + 1;
                if (nextStageId <= TOTAL_STAGES) {
                    const nextSuccess = await saveUserProgress(currentUserId, nextStageId, 'current');
                    if (nextSuccess) { userProgress[nextStageId] = 'current'; } 
                    else { alert('æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®è§£æ”¾ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
                }
                updateStageDisplay();
                closeStageModal();
                setTimeout(() => { alert(`ã‚¹ãƒ†ãƒ¼ã‚¸ ${currentStageIdForModal} ã‚¯ãƒªã‚¢ï¼ğŸ‰ ${nextStageId <= TOTAL_STAGES && userProgress[nextStageId] === 'current' ? 'æ¬¡ã®å†’é™ºã¸é€²ã‚‚ã†ï¼' : 'å…¨ã¦ã®å†’é™ºã‚’é”æˆã—ã¾ã—ãŸï¼'}`); }, 100);
            } else { alert('é€²æ—ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
        });
        // ãƒ¡ã‚¤ãƒ³ã‚¯ã‚¨ã‚¹ãƒˆãƒœã‚¿ãƒ³
        mainQuestButton.addEventListener('click', () => { /* ...å‰å›åŒæ§˜ã®ãƒ­ã‚¸ãƒƒã‚¯... */ 
            const currentStageEntry = Object.entries(userProgress).find(([_, status]) => status === 'current');
            if (currentStageEntry) { openStageModal(parseInt(currentStageEntry[0])); } 
            else if (Object.values(userProgress).every(s => s === 'completed')) { /* no-op */ } 
            else { alert('å†’é™ºã‚’å§‹ã‚ã‚‹æº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚'); }
        });
        // å†’é™ºã®è¨˜éŒ²
        document.getElementById('adventureLogBtn').addEventListener('click', () => { /* ...å‰å›åŒæ§˜ã®ãƒ­ã‚¸ãƒƒã‚¯... */ 
            let logText = "ğŸ“– ã“ã‚Œã¾ã§ã®å†’é™ºã®è¨˜éŒ²\n\n"; let completedCount = 0;
            for (let i = 1; i <= TOTAL_STAGES; i++) {
                if (userProgress[i] === 'completed') { logText += `ã‚¹ãƒ†ãƒ¼ã‚¸${i}: ${stageStaticData[i].title} - ã‚¯ãƒªã‚¢æ¸ˆã¿\n`; completedCount++; }
                else if (userProgress[i] === 'current') { logText += `ã‚¹ãƒ†ãƒ¼ã‚¸${i}: ${stageStaticData[i].title} - æŒ‘æˆ¦ä¸­\n`; }
            }
            if (completedCount === 0 && !Object.values(userProgress).some(s => s === 'current')) { logText += 'ã¾ã å†’é™ºã¯å§‹ã¾ã£ãŸã°ã‹ã‚Šã§ã™ï¼'; }
            logText += `\nä¸»äººå…¬ãƒ¬ãƒ™ãƒ«: ${heroLevel}`; alert(logText);
        });

        // --- åˆæœŸåŒ–å‡¦ç† ---
        async function initializeApp() {
            createSkyObjects(); // èƒŒæ™¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆã‚’è¿½åŠ 
            currentUserId = getUserIdFromUrl();
            if (!currentUserId) {
                currentUserId = 'testUser001'; 
                console.warn('User ID not found, using default testUser001');
            }
            userProgress = await fetchUserProgress(currentUserId);
            updateStageDisplay();
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
