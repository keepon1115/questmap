<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAFT ã‚¯ã‚¨ã‚¹ãƒˆãƒãƒƒãƒ— - å†’é™ºã®æ›¸</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        body {
            font-family: 'DotGothic16', 'M PLUS Rounded 1c', sans-serif;
            line-height: 1.6;
            color: #2c2c2c;
            overflow-x: hidden;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 50%, #B0E0E6 100%);
            min-height: 100vh;
            position: relative;
        }
        
        /* é›²ã®èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        body::before,
        body::after {
            content: '';
            position: fixed;
            width: 100px;
            height: 40px;
            background: white;
            border-radius: 100px;
            opacity: 0.8;
            box-shadow: 
                20px 10px 0 10px white,
                -20px 10px 0 5px white;
        }
        
        body::before {
            top: 10%;
            left: -150px;
            animation: float-cloud 30s infinite linear;
        }
        
        body::after {
            top: 30%;
            right: -150px;
            animation: float-cloud-reverse 25s infinite linear;
        }
        
        @keyframes float-cloud {
            from { transform: translateX(0); }
            to { transform: translateX(calc(100vw + 300px)); }
        }
        
        @keyframes float-cloud-reverse {
            from { transform: translateX(0); }
            to { transform: translateX(calc(-100vw - 300px)); }
        }
        
        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ã‚¢ãƒ¼ãƒˆé¢¨ï¼‰ */
        .hamburger {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            width: 48px;
            height: 48px;
            background: #8B4513;
            border: 3px solid #654321;
            border-radius: 0;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 6px;
            transition: transform 0.1s ease;
            box-shadow: 
                0 0 0 1px #A0522D,
                3px 3px 0 0 rgba(0,0,0,0.3);
        }
        
        .hamburger:hover {
            transform: translate(-1px, -1px);
            box-shadow: 
                0 0 0 1px #A0522D,
                4px 4px 0 0 rgba(0,0,0,0.3);
        }
        
        .hamburger:active {
            transform: translate(1px, 1px);
            box-shadow: 
                0 0 0 1px #A0522D,
                2px 2px 0 0 rgba(0,0,0,0.3);
        }
        
        .hamburger span {
            width: 24px;
            height: 4px;
            background: #F5DEB3;
            border-radius: 0;
            transition: all 0.3s ease;
        }
        
        /* ã‚µã‚¤ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .side-nav {
            position: fixed;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100vh;
            background: #2C1810;
            border-right: 4px solid #654321;
            z-index: 999;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            padding: 80px 20px 20px;
        }
        
        @media (min-width: 768px) {
            .side-nav {
                width: 280px;
            }
        }
        
        .side-nav.active {
            left: 0;
        }
        
        .side-nav-item {
            padding: 16px 20px;
            margin: 8px 0;
            background: #3D2817;
            border: 2px solid #654321;
            cursor: pointer;
            transition: all 0.1s ease;
            font-weight: 500;
            color: #F5DEB3;
            text-align: center;
            position: relative;
            box-shadow: 2px 2px 0 0 rgba(0,0,0,0.5);
        }
        
        .side-nav-item:hover {
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 0 rgba(0,0,0,0.5);
            background: #4D3827;
        }
        
        .side-nav-item:active {
            transform: translate(0, 0);
            box-shadow: 1px 1px 0 0 rgba(0,0,0,0.5);
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 80px 16px 40px;
            position: relative;
            z-index: 10;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .map-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .map-header h1 {
            font-size: 2.5rem;
            color: #FFF;
            margin-bottom: 16px;
            text-shadow: 
                2px 2px 0 #4DB6F7,
                4px 4px 0 #3A8BC4,
                6px 6px 8px rgba(0,0,0,0.3);
            letter-spacing: 2px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .map-header p {
            font-size: 1.1rem;
            color: #FFF;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.2);
            display: inline-block;
            padding: 4px 16px;
            border-radius: 0;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        /* å†’é™ºã®è¨˜éŒ²ãƒœã‚¿ãƒ³ */
        .adventure-log-button {
            display: inline-block;
            margin: 20px auto 0;
            padding: 12px 32px;
            background: #FFD700;
            border: 3px solid #B8860B;
            color: #654321;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            position: relative;
            box-shadow: 
                0 0 0 1px #DAA520,
                4px 4px 0 0 rgba(0,0,0,0.3);
            transition: all 0.1s ease;
        }
        
        .adventure-log-button::before {
            content: 'ğŸ“–';
            margin-right: 8px;
        }
        
        .adventure-log-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 
                0 0 0 1px #DAA520,
                6px 6px 0 0 rgba(0,0,0,0.3);
        }
        
        .adventure-log-button:active {
            transform: translate(1px, 1px);
            box-shadow: 
                0 0 0 1px #DAA520,
                2px 2px 0 0 rgba(0,0,0,0.3);
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸ã‚°ãƒªãƒƒãƒ‰ */
        .stage-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 32px;
            margin-bottom: 40px;
            padding: 0 20px;
        }
        
        @media (max-width: 767px) {
            .stage-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 24px;
                padding: 0;
            }
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸ãƒãƒ¼ãƒ‰ */
        .stage-node {
            position: relative;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .stage-node:nth-child(2),
        .stage-node:nth-child(5) {
            transform: translateY(40px);
        }
        
        @media (max-width: 767px) {
            .stage-node:nth-child(even) {
                transform: translateY(40px);
            }
            .stage-node:nth-child(5) {
                transform: translateY(0);
            }
        }
        
        .stage-node:hover {
            transform: translateY(-5px) scale(1.05);
        }
        
        .stage-node:nth-child(2):hover,
        .stage-node:nth-child(5):hover {
            transform: translateY(35px) scale(1.05);
        }
        
        @media (max-width: 767px) {
            .stage-node:nth-child(even):hover {
                transform: translateY(35px) scale(1.05);
            }
            .stage-node:nth-child(5):hover {
                transform: translateY(-5px) scale(1.05);
            }
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¢ã‚¤ã‚³ãƒ³ */
        .stage-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 16px;
            position: relative;
            background: #E8F5E9;
            border: 4px solid #333;
            box-shadow: 
                0 0 0 2px #666,
                6px 6px 0 0 rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px; /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµµæ–‡å­—ç”¨ */
            transition: all 0.3s ease;
            overflow: hidden; /* ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”»åƒãŒã¯ã¿å‡ºãªã„ã‚ˆã†ã« */
        }
        
        .stage-node.locked .stage-icon {
            background: #9E9E9E;
            filter: grayscale(1);
            opacity: 0.7;
        }
        
        .stage-node.completed .stage-icon {
            background: #FFF9C4;
            box-shadow: 
                0 0 0 2px #FFD700,
                6px 6px 0 0 rgba(0,0,0,0.3),
                0 0 20px rgba(255,215,0,0.5);
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒ */
        .stage-icon img.icon-image { /* ã‚¯ãƒ©ã‚¹åå¤‰æ›´ */
            width: 64px; /* ã‚µã‚¤ã‚ºæŒ‡å®šã¯ã“ã“ã§è¡Œã† */
            height: 64px;
            object-fit: contain; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã¤ */
            image-rendering: pixelated;
            display: block; /* æœ€åˆã¯è¡¨ç¤ºã€JSã§ã‚¨ãƒ©ãƒ¼æ™‚éè¡¨ç¤ºã« */
        }
        
        .stage-icon .icon-fallback {
            font-size: 64px;
            display: none; /* æœ€åˆã¯éè¡¨ç¤ºã€ç”»åƒã‚¨ãƒ©ãƒ¼æ™‚ã«JSã§è¡¨ç¤º */
        }
        
        /* ã‚¯ãƒªã‚¢æ¼”å‡ºç”»åƒ */
        .clear-effect {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            object-fit: contain;
            display: none; /* JSã§completedæ™‚ã«è¡¨ç¤º */
            z-index: 2;
            animation: effect-animation 2s ease-in-out infinite; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯å…±é€šã§è‰¯ã„ã‹æ¤œè¨ */
        }
        
        /* å€‹åˆ¥ã®ã‚¯ãƒªã‚¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¿…è¦ãªã‚‰ï¼‰ */
        /* .clear-effect.smoke { animation: smoke-animation 2s infinite; } */
        /* .clear-effect.animal { animation: animal-animation 3s infinite; } */
        
        .stage-node.completed .clear-effect {
            display: block;
        }
        
        @keyframes effect-animation { /*æ±ç”¨çš„ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹*/
            0%, 100% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0.9; }
            25% { transform: translateY(-5px) scale(1.1) rotate(5deg); opacity: 1; }
            50% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0.9; }
            75% { transform: translateY(-3px) scale(1.05) rotate(-5deg); opacity: 1; }
        }
        
        /* CLEARãƒãƒƒã‚¸ */
        .clear-badge {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: #FFD700;
            border: 3px solid #B8860B;
            padding: 4px 12px;
            font-weight: bold;
            font-size: 14px;
            color: #654321;
            letter-spacing: 1px;
            box-shadow: 
                0 0 0 1px #DAA520,
                3px 3px 0 0 rgba(0,0,0,0.5);
            z-index: 10;
            animation: bounce-in 0.5s ease;
            display: none;
        }
        
        .stage-node.completed .clear-badge {
            display: block;
        }
        
        @keyframes bounce-in {
            0% { transform: translateX(-50%) translateY(-20px) scale(0); }
            50% { transform: translateX(-50%) translateY(0) scale(1.2); }
            100% { transform: translateX(-50%) translateY(0) scale(1); }
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸ç•ªå·ãƒãƒƒã‚¸ */
        .stage-number-badge {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: #4DB6F7;
            border: 3px solid #2C88C7;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* å·¦æƒãˆ */
            padding-left: 12px; /* å·¦ã®ä½™ç™½ */
            font-size: 20px;
            font-weight: bold;
            color: white;
            box-shadow: 
                0 0 0 1px #5AC8F7,
                3px 3px 0 0 rgba(0,0,0,0.3);
            z-index: 5;
        }
        
        .stage-node.locked .stage-number-badge {
            background: #757575;
            border-color: #616161;
            box-shadow: 
                0 0 0 1px #9E9E9E,
                3px 3px 0 0 rgba(0,0,0,0.3);
        }
        
        /* ä¸»äººå…¬ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ */
        .hero-character {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 48px;
            height: 48px;
            z-index: 20;
            animation: hero-idle 0.8s steps(2) infinite;
            display: none; /* JSã§currentæ™‚ã«è¡¨ç¤º */
        }
        
        .stage-node.current .hero-character {
            display: block;
        }
        
        @keyframes hero-idle {
            0% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-2px); }
        }
        
        /* ä¸»äººå…¬ã®è¦‹ãŸç›®ï¼ˆCSS ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆé¢¨ï¼‰ */
        .hero-sprite {
            width: 100%;
            height: 100%;
            background-size: 48px 48px; /* CSSã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒãŒã‚ã‚‹ãªã‚‰ãã®å…¨ä½“ã®ã‚µã‚¤ã‚º */
            image-rendering: pixelated;
            /* background-image: url('path/to/hero-spritesheet.png'); */ /* ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆã‚’ä½¿ã†å ´åˆ */
        }
        
        /* ä»¥ä¸‹ã¯CSSã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®è¡¨ç¾ä¾‹ã€‚ç”»åƒã‚’ä½¿ã†å ´åˆã¯ä¸è¦ã«ãªã‚‹ã‹ã€ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã®background-positionã§åˆ¶å¾¡ */
        .hero-level-1 {
            background: 
                linear-gradient(to right, transparent 45%, #8B4513 45%, #8B4513 55%, transparent 55%),
                linear-gradient(to bottom, #F4A460 0%, #F4A460 30%, #4169E1 30%, #4169E1 70%, #8B4513 70%);
            /* background-position: 0 0; ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã®å ´åˆ */
        }
        
        .hero-level-2 {
            background: 
                linear-gradient(to bottom, #FF0000 0%, #FF0000 15%, transparent 15%),
                linear-gradient(to right, transparent 45%, #8B4513 45%, #8B4513 55%, transparent 55%),
                linear-gradient(to bottom, #F4A460 15%, #F4A460 35%, #4169E1 35%, #4169E1 70%, #8B4513 70%);
            /* background-position: -48px 0; ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã®å ´åˆ */
        }
        
        .hero-level-3 {
            background: 
                linear-gradient(to right, transparent 70%, #C0C0C0 70%, #C0C0C0 75%, transparent 75%),
                linear-gradient(to bottom, #FF0000 0%, #FF0000 15%, transparent 15%),
                linear-gradient(to right, transparent 45%, #8B4513 45%, #8B4513 55%, transparent 55%),
                linear-gradient(to bottom, #F4A460 15%, #F4A460 35%, #32CD32 35%, #32CD32 70%, #8B4513 70%);
            /* background-position: -96px 0; ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã®å ´åˆ */
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ± */
        .stage-info {
            background: white;
            border: 3px solid #333;
            padding: 12px 16px;
            margin-top: 16px;
            position: relative;
            box-shadow: 
                0 0 0 1px #666,
                4px 4px 0 0 rgba(0,0,0,0.2);
        }
        
        .stage-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        
        .stage-description {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }
        
        /* ãƒ‘ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆé“ï¼‰ */
        .path-line {
            position: absolute;
            width: 60px;
            height: 4px;
            background: repeating-linear-gradient(
                90deg,
                #8B4513,
                #8B4513 10px,
                #D2691E 10px,
                #D2691E 20px
            );
            top: 50%; /* ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸­å¿ƒã«åˆã‚ã›ã‚‹ãŸã‚èª¿æ•´ãŒå¿…è¦ã‹ã‚‚ */
            right: -60px; /* stage-nodeã®å³ç«¯ã‹ã‚‰å¤–ã¸ */
            transform: translateY(-50%);
            z-index: 1;
        }
        
        .stage-node:nth-child(3n) .path-line, /* å„è¡Œã®æœ€å¾Œã®è¦ç´  */
        .stage-node:last-child .path-line { /* ã‚°ãƒªãƒƒãƒ‰å…¨ä½“ã®æœ€å¾Œã®è¦ç´  */
            display: none;
        }
        
        @media (max-width: 767px) {
            .stage-node:nth-child(3n) .path-line { display: block; } /* 3åˆ—ç›®ã®ãƒ‘ã‚¹è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ */
            .stage-node:nth-child(2n) .path-line, /* SPã§ã¯å„è¡Œã®æœ€å¾Œã®è¦ç´  */
            .stage-node:last-child .path-line {
                display: none;
            }
        }
        
        /* ã‚¯ã‚¨ã‚¹ãƒˆãƒœã‚¿ãƒ³ */
        .quest-button {
            display: block;
            width: fit-content;
            margin: 40px auto;
            padding: 16px 48px;
            background: #FF6B6B;
            border: 4px solid #DC143C;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            box-shadow: 
                0 0 0 2px #FF8787,
                6px 6px 0 0 rgba(0,0,0,0.3);
            transition: all 0.1s ease;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .quest-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 
                0 0 0 2px #FF8787,
                8px 8px 0 0 rgba(0,0,0,0.3);
            animation: none;
        }
        
        .quest-button:active {
            transform: translate(2px, 2px);
            box-shadow: 
                0 0 0 2px #FF8787,
                2px 2px 0 0 rgba(0,0,0,0.3);
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            align-items: center; /* Flexboxã§ä¸­å¤®æƒãˆ */
            justify-content: center; /* Flexboxã§ä¸­å¤®æƒãˆ */
        }
        
        .modal-content {
            /* position, top, left, transform ã¯Flexboxä¸­å¤®æƒãˆã®ãŸã‚ä¸è¦ã« */
            background: #F5F5DC;
            border: 4px solid #8B4513;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 
                0 0 0 2px #A0522D,
                8px 8px 0 0 rgba(0,0,0,0.5);
            position: relative; /* ã‚¯ãƒ­ãƒ¼ã‚ºãƒœã‚¿ãƒ³ã®åŸºæº–ã®ãŸã‚ */
        }
        
        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: #DC143C;
            border: 2px solid #8B0000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            font-weight: bold;
            box-shadow: 2px 2px 0 0 rgba(0,0,0,0.5);
        }
        
        .modal-close:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 0 rgba(0,0,0,0.5);
        }
        
        .modal-close:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 0 rgba(0,0,0,0.5);
        }
        
        .modal-title {
            font-size: 1.6rem;
            color: #8B4513;
            margin-bottom: 16px;
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
        }
        
        .modal-description {
            color: #654321;
            margin-bottom: 20px;
            line-height: 1.6;
            text-align: center;
        }
        
        .modal-message {
            background: #FFF9C4;
            border: 2px solid #F9A825;
            padding: 16px;
            margin-bottom: 24px;
            text-align: center;
            font-style: italic;
            color: #5D4037;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.1);
        }
        
        .modal-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
        }
        
        @media (max-width: 767px) {
            .modal-buttons {
                flex-direction: column;
            }
        }
        
        .modal-button {
            flex: 1;
            padding: 12px 24px;
            border: 3px solid;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s ease;
            position: relative;
        }
        
        .modal-button.video {
            background: #4CAF50;
            border-color: #388E3C;
            color: white;
            box-shadow: 
                0 0 0 1px #66BB6A,
                4px 4px 0 0 rgba(0,0,0,0.3);
        }
        
        .modal-button.video:hover {
            transform: translate(-2px, -2px);
            box-shadow: 
                0 0 0 1px #66BB6A,
                6px 6px 0 0 rgba(0,0,0,0.3);
        }
        
        .modal-button.quest {
            background: #2196F3;
            border-color: #1976D2;
            color: white;
            box-shadow: 
                0 0 0 1px #42A5F5,
                4px 4px 0 0 rgba(0,0,0,0.3);
        }
        
        .modal-button.quest:hover {
            transform: translate(-2px, -2px);
            box-shadow: 
                0 0 0 1px #42A5F5,
                6px 6px 0 0 rgba(0,0,0,0.3);
        }
        
        .modal-button:active {
            transform: translate(1px, 1px);
            box-shadow: 
                0 0 0 1px currentColor, /* è‡ªèº«ã®èƒŒæ™¯è‰²ã§å…‰ã‚‹ã‚ˆã†ã« */
                2px 2px 0 0 rgba(0,0,0,0.3);
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
        .loading-overlay { /* åç§°å¤‰æ›´ */
            display: none; /* JSã§åˆ¶å¾¡ */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5); /* åŠé€æ˜èƒŒæ™¯ */
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .loading-content { /* ã‚³ãƒ³ãƒ†ãƒŠè¿½åŠ  */
            text-align: center;
            background: #F5F5DC;
            padding: 30px;
            border: 4px solid #8B4513;
            box-shadow: 
                0 0 0 2px #A0522D,
                8px 8px 0 0 rgba(0,0,0,0.5);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4DB6F7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-content p {
            color: #654321;
            font-weight: bold;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>å†’é™ºã®æº–å‚™ä¸­...</p>
        </div>
    </div>
    
    <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
    </div>
    
    <!-- ã‚µã‚¤ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="side-nav" id="sideNav">
        <div class="side-nav-item">ğŸ  ãƒ›ãƒ¼ãƒ </div>
        <div class="side-nav-item">âš”ï¸ ã‚¸ãƒ–ãƒ³ã‚¯ãƒ©ãƒ•ãƒˆ</div>
        <div class="side-nav-item">ğŸ—ºï¸ ã‚¯ã‚¨ã‚¹ãƒˆ</div>
        <div class="side-nav-item">ğŸŒ Yononaka</div>
        <div class="side-nav-item">ğŸš€ ãƒŸãƒ©ã‚¤ã‚¯ãƒ©ãƒ•ãƒˆ</div>
    </nav>
    
    <div class="container">
        <header class="map-header">
            <h1>ğŸ—ºï¸ CLAFT ã‚¯ã‚¨ã‚¹ãƒˆãƒãƒƒãƒ—</h1>
            <p>ãã¿ã ã‘ã®å†’é™ºç‰©èªã‚’ã¤ãã‚ã†ï¼</p>
            <button class="adventure-log-button" id="adventureLogBtn">
                ã“ã‚Œã¾ã§ã®å†’é™ºã‚’æŒ¯ã‚Šè¿”ã‚‹
            </button>
        </header>
        
        <div class="stage-grid" id="stageGrid">
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¸1 -->
            <div class="stage-node" id="stage-1" data-stage-id="1">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character">
                    <div class="hero-sprite hero-level-1"></div>
                </div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/8B4513/FFFFFF?text=House" alt="ã‚¹ãƒ†ãƒ¼ã‚¸1ã‚¢ã‚¤ã‚³ãƒ³" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">ğŸ </span>
                    <img class="clear-effect" src="https://via.placeholder.com/32x32/CCCCCC/000000?text=Smoke" alt="ç…™ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ" data-effect-type="smoke">
                </div>
                <div class="stage-number-badge">1</div>
                <div class="stage-info">
                    <h3 class="stage-title"></h3> <!-- JSã§è¨­å®š -->
                    <p class="stage-description"></p> <!-- JSã§è¨­å®š -->
                </div>
                <div class="path-line"></div>
            </div>
            
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¸2 -->
            <div class="stage-node" id="stage-2" data-stage-id="2">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character">
                    <div class="hero-sprite hero-level-1"></div>
                </div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/228B22/FFFFFF?text=Forest" alt="ã‚¹ãƒ†ãƒ¼ã‚¸2ã‚¢ã‚¤ã‚³ãƒ³" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">ğŸŒ²</span>
                    <img class="clear-effect" src="https://via.placeholder.com/32x32/8B4513/FFFFFF?text=Animal" alt="å‹•ç‰©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ" data-effect-type="animal">
                </div>
                <div class="stage-number-badge">2</div>
                <div class="stage-info">
                    <h3 class="stage-title"></h3>
                    <p class="stage-description"></p>
                </div>
                <div class="path-line"></div>
            </div>
            
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¸3 -->
            <div class="stage-node" id="stage-3" data-stage-id="3">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character">
                    <div class="hero-sprite hero-level-1"></div>
                </div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/4169E1/FFFFFF?text=Sword" alt="ã‚¹ãƒ†ãƒ¼ã‚¸3ã‚¢ã‚¤ã‚³ãƒ³" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">âš”ï¸</span>
                    <!-- No clear effect for this stage in the example -->
                </div>
                <div class="stage-number-badge">3</div>
                <div class="stage-info">
                    <h3 class="stage-title"></h3>
                    <p class="stage-description"></p>
                </div>
                <div class="path-line"></div>
            </div>
            
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¸4 -->
            <div class="stage-node" id="stage-4" data-stage-id="4">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character">
                    <div class="hero-sprite hero-level-1"></div>
                </div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/FFD700/000000?text=Shield" alt="ã‚¹ãƒ†ãƒ¼ã‚¸4ã‚¢ã‚¤ã‚³ãƒ³" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">ğŸ›¡ï¸</span>
                </div>
                <div class="stage-number-badge">4</div>
                <div class="stage-info">
                    <h3 class="stage-title"></h3>
                    <p class="stage-description"></p>
                </div>
                <div class="path-line"></div>
            </div>
            
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¸5 -->
            <div class="stage-node" id="stage-5" data-stage-id="5">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character">
                    <div class="hero-sprite hero-level-1"></div>
                </div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/32CD32/FFFFFF?text=Team" alt="ã‚¹ãƒ†ãƒ¼ã‚¸5ã‚¢ã‚¤ã‚³ãƒ³" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">ğŸ‘¥</span>
                </div>
                <div class="stage-number-badge">5</div>
                <div class="stage-info">
                    <h3 class="stage-title"></h3>
                    <p class="stage-description"></p>
                </div>
                <div class="path-line"></div>
            </div>
            
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¸6 -->
            <div class="stage-node" id="stage-6" data-stage-id="6">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character">
                    <div class="hero-sprite hero-level-1"></div>
                </div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/8B0000/FFFFFF?text=Boss" alt="ã‚¹ãƒ†ãƒ¼ã‚¸6ã‚¢ã‚¤ã‚³ãƒ³" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">ğŸ°</span>
                </div>
                <div class="stage-number-badge">6</div>
                <div class="stage-info">
                    <h3 class="stage-title"></h3>
                    <p class="stage-description"></p>
                </div>
                <!-- No path-line for the last stage -->
            </div>
        </div>
        
        <button class="quest-button" id="mainQuestButton">ğŸ”¥ æ¬¡ã®å†’é™ºã¸é€²ã‚€ï¼</button>
    </div>
    
    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="stageModal">
        <div class="modal-content">
            <button class="modal-close" id="modalCloseBtn">Ã—</button>
            <h2 class="modal-title" id="modalStageTitle"></h2>
            <p class="modal-description" id="modalStageDescription"></p>
            <div class="modal-message" id="modalStageMessage"></div>
            <div class="modal-buttons">
                <button class="modal-button video" id="modalVideoBtn">ğŸ¬ å‹•ç”»ã‚’è¦‹ã‚‹</button>
                <button class="modal-button quest" id="modalQuestBtn">âš”ï¸ ã‚¯ã‚¨ã‚¹ãƒˆã«æŒ‘ã‚€</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š ---
        const ADALO_API_ENDPOINT = 'YOUR_ADALO_ENDPOINT/collections/YOUR_PROGRESS_COLLECTION_ID'; // ä¾‹: https://api.adalo.com/v0/apps/YOUR_APP_ID/collections/YOUR_COLLECTION_ID
        const ADALO_API_KEY = 'Bearer YOUR_ADALO_API_KEY';
        const TOTAL_STAGES = 6;

        // ã‚¹ãƒ†ãƒ¼ã‚¸ã®é™çš„æƒ…å ±ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
        // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒURLã‚„ã‚¯ãƒªã‚¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”»åƒURLã‚‚ã“ã“ã«å®šç¾©ã™ã‚‹ã¨ç®¡ç†ã—ã‚„ã™ã„
        const stageStaticData = {
            1: {
                title: 'å›ã¯ã©ã‚“ãªå†’é™ºè€…ï¼Ÿ',
                description: 'ã“ã®ä¸–ç•Œã®åœ°å›³ã‚’ã²ã‚‰ã„ã¦ã€CLAFTã‚’å†’é™ºã—ã‚ˆã†ï¼',
                message: 'ã€Œã“ã®ä¸–ç•Œã‚’ã©ã†æ­©ãã‹ã¯ã€è‡ªåˆ†ã§æ±ºã‚ã¦ã„ã„ã€',
                iconImage: 'https://via.placeholder.com/64x64/8B4513/FFFFFF?text=House',
                clearEffectImage: 'https://via.placeholder.com/32x32/CCCCCC/000000?text=Smoke'
            },
            2: {
                title: 'ãƒ¯ã‚¯ã‚‚ã‚„ã‚¨ãƒãƒ«ã‚®ãƒ¼',
                description: 'ãƒ¯ã‚¯ãƒ¯ã‚¯ãƒ»ã‚‚ã‚„ã‚‚ã‚„ã¯å•ã„ã®åŸå‹•åŠ›ã«ãªã‚‹',
                message: 'ã€Œå›ã®æ„Ÿã˜ãŸ"ã‚‚ã‚„ã‚‚ã‚„"ãŒã€å†’é™ºã®å‡ºç™ºç‚¹ã€',
                iconImage: 'https://via.placeholder.com/64x64/228B22/FFFFFF?text=Forest',
                clearEffectImage: 'https://via.placeholder.com/32x32/8B4513/FFFFFF?text=Animal'
            },
            3: {
                title: 'å›ã¯ã©ã‚“ãªã‚­ãƒ£ãƒ©ï¼Ÿ',
                description: 'è‡ªåˆ†ã‚’è‚²ã¦ã‚‹è‚²æˆã‚²ãƒ¼ãƒ ',
                message: 'ã€Œè‡ªåˆ†ã®ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ã‚’è‚²ã¦ã‚‹ã®ã¯ã€å›è‡ªèº«ã ã€',
                iconImage: 'https://via.placeholder.com/64x64/4169E1/FFFFFF?text=Sword',
                clearEffectImage: null // ã“ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãªã—
            },
            4: {
                title: 'ã©ã‚“ãªé“å…·ã‚’æŒã£ã¦ã‚‹ï¼Ÿ',
                description: 'ã“ã®ä¸–ç•Œã®åœ°å›³ã‚’ã²ã‚‰ã„ã¦ã€CLAFTã‚’å†’é™ºã—ã‚ˆã†ï¼',
                message: 'ã€Œè‡ªåˆ†ã®ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ã‚’è‚²ã¦ã‚‹ã®ã¯ã€å›è‡ªèº«ã ã€',
                iconImage: 'https://via.placeholder.com/64x64/FFD700/000000?text=Shield',
                clearEffectImage: null
            },
            5: {
                title: 'ä»²é–“ã¨å†’é™ºã™ã‚‹ã£ã¦ï¼Ÿ',
                description: 'ã“ã®ä¸–ç•Œã®åœ°å›³ã‚’ã²ã‚‰ã„ã¦ã€CLAFTã‚’å†’é™ºã—ã‚ˆã†ï¼',
                message: 'ã€Œè‡ªåˆ†ã®ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ã‚’è‚²ã¦ã‚‹ã®ã¯ã€å›è‡ªèº«ã ã€',
                iconImage: 'https://via.placeholder.com/64x64/32CD32/FFFFFF?text=Team',
                clearEffectImage: null
            },
            6: {
                title: 'æœªæ¥ã®ãƒœã‚¹ã¨å‘ãåˆã†',
                description: 'ã“ã®ä¸–ç•Œã®åœ°å›³ã‚’ã²ã‚‰ã„ã¦ã€CLAFTã‚’å†’é™ºã—ã‚ˆã†ï¼',
                message: 'ã€Œè‡ªåˆ†ã®ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ã‚’è‚²ã¦ã‚‹ã®ã¯ã€å›è‡ªèº«ã ã€',
                iconImage: 'https://via.placeholder.com/64x64/8B0000/FFFFFF?text=Boss',
                clearEffectImage: null
            }
        };

        // --- DOMè¦ç´ å–å¾— ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const stageGrid = document.getElementById('stageGrid');
        const mainQuestButton = document.getElementById('mainQuestButton');
        const stageModal = document.getElementById('stageModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalStageTitle = document.getElementById('modalStageTitle');
        const modalStageDescription = document.getElementById('modalStageDescription');
        const modalStageMessage = document.getElementById('modalStageMessage');
        const modalVideoBtn = document.getElementById('modalVideoBtn');
        const modalQuestBtn = document.getElementById('modalQuestBtn');
        
        let currentUserId = null;
        let userProgress = {}; // { 1: 'completed', 2: 'current', 3: 'locked', ... }
        let heroLevel = 1;
        let currentStageIdForModal = null;


        // --- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º ---
        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾— ---
        function getUserIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('userId');
        }

        // --- Adalo APIé€£æº (ã‚¹ã‚¿ãƒ–) ---
        async function fetchUserProgress(userId) {
            showLoading(true);
            console.log(`Fetching progress for userId: ${userId}`);
            // --- ã‚¹ã‚¿ãƒ–å®Ÿè£… ---
            // Adaloã§ã¯ã€ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€²æ—ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
            // ä¾‹: GET ${ADALO_API_ENDPOINT}?filter[userId]=${userId}
            // å®Ÿéš›ã«ã¯fetch APIã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
            return new Promise(resolve => {
                setTimeout(() => {
                    // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿: Adalo APIã‹ã‚‰è¿”ã•ã‚Œã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã®é…åˆ—ã‚’æƒ³å®š
                    // åˆå›ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ç©ºã®é…åˆ—ãŒè¿”ã‚‹ã‹ã€è©²å½“ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„ã“ã¨ã‚’æƒ³å®š
                    const dummyApiResponse = [
                        // { "id": "rec_abc", "userId": userId, "stageId": 1, "status": "completed", "Name": `Progress ${userId}-1`}, // Adaloã®ãƒ¬ã‚³ãƒ¼ãƒ‰å½¢å¼ã«åˆã‚ã›ã‚‹
                        // { "id": "rec_def", "userId": userId, "stageId": 2, "status": "current", "Name": `Progress ${userId}-2`}
                    ];
                    
                    const progress = {};
                    for (let i = 1; i <= TOTAL_STAGES; i++) {
                        const record = dummyApiResponse.find(r => r.stageId === i);
                        progress[i] = record ? record.status : (i === 1 ? 'current' : 'locked'); // åˆå›ã¯ã‚¹ãƒ†ãƒ¼ã‚¸1ãŒcurrent
                    }
                    // ã‚‚ã—ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒï¼‘ã¤ã‚‚ãªã‘ã‚Œã°ã€ã‚¹ãƒ†ãƒ¼ã‚¸1ã‚’current, ãã‚Œä»¥å¤–ã‚’lockedã¨ã™ã‚‹
                    if (dummyApiResponse.length === 0) {
                        progress[1] = 'current';
                        for (let i = 2; i <= TOTAL_STAGES; i++) {
                            progress[i] = 'locked';
                        }
                    }

                    console.log('Dummy progress fetched:', progress);
                    showLoading(false);
                    resolve(progress);
                }, 1000); // 1ç§’ã®é…å»¶ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            });
            // --- å®Ÿéš›ã®fetchã®ä¾‹ ---
            /*
            try {
                const response = await fetch(`${ADALO_API_ENDPOINT}?filter[userId]=${userId}`, { // Adaloã®ãƒ•ã‚£ãƒ«ã‚¿æ§‹æ–‡ã«æ³¨æ„
                    method: 'GET',
                    headers: {
                        'Authorization': ADALO_API_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json(); // Adaloã¯ records: [] ã®å½¢ã§è¿”ã™ã“ã¨ãŒå¤šã„
                
                const progress = {};
                for (let i = 1; i <= TOTAL_STAGES; i++) {
                    // Adaloã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰è©²å½“ã‚¹ãƒ†ãƒ¼ã‚¸ã®statusã‚’æ¢ã™
                    // Adaloã§ã¯é€šå¸¸ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã€ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¿”ã£ã¦ãã‚‹
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«é€²æ—ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆãƒ»æ›´æ–°ã™ã‚‹é‹ç”¨ã‚’æƒ³å®š
                    const record = data.records.find(r => r.fields.stageId === i && r.fields.userId === userId); // Adaloã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã«åˆã‚ã›ã‚‹
                    progress[i] = record ? record.fields.status : (i === 1 && !data.records.some(r => r.fields.userId === userId) ? 'current' : 'locked');
                }
                if (data.records.length === 0 || !data.records.some(r => r.fields.userId === userId) ) { // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€²æ—ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä¸€ã¤ã‚‚ãªã„å ´åˆ
                     progress[1] = 'current';
                     for (let i = 2; i <= TOTAL_STAGES; i++) progress[i] = 'locked';
                }
                return progress;
            } catch (error) {
                console.error('Failed to fetch user progress:', error);
                showLoading(false);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€²æ—ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸1ãŒcurrentï¼‰ã‚’è¿”ã™ãªã©ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const defaultProgress = {};
                for (let i = 1; i <= TOTAL_STAGES; i++) defaultProgress[i] = (i === 1 ? 'current' : 'locked');
                return defaultProgress;
            } finally {
                showLoading(false);
            }
            */
        }

        async function saveUserProgress(userId, stageId, newStatus) {
            showLoading(true);
            console.log(`Saving progress for userId: ${userId}, stageId: ${stageId}, status: ${newStatus}`);
            // --- ã‚¹ã‚¿ãƒ–å®Ÿè£… ---
            // Adaloã§ã¯ã€ç‰¹å®šã®é€²æ—ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã™ã‚‹ã‹ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆã—ã¾ã™ã€‚
            // 1. userIdã¨stageIdã§æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢
            // 2. ã‚ã‚Œã°UPDATE (PATCH request to ${ADALO_API_ENDPOINT}/${recordId})
            // 3. ãªã‘ã‚Œã°CREATE (POST request to ${ADALO_API_ENDPOINT})
            return new Promise(resolve => {
                setTimeout(() => {
                    userProgress[stageId] = newStatus;
                    console.log('Dummy progress saved:', userProgress);
                    showLoading(false);
                    resolve(true); // ä¿å­˜æˆåŠŸ
                }, 500);
            });
            // --- å®Ÿéš›ã®fetchã®ä¾‹ ---
            /*
            try {
                // ã¾ãšã€userIdã¨stageIdã§æ—¢å­˜ã®é€²æ—ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã‹ç¢ºèª
                const searchResponse = await fetch(`${ADALO_API_ENDPOINT}?filter[userId]=${userId}&filter[stageId]=${stageId}`, {
                    method: 'GET',
                    headers: { 'Authorization': ADALO_API_KEY, 'Content-Type': 'application/json' }
                });
                const searchData = await searchResponse.json();
                const existingRecord = searchData.records.length > 0 ? searchData.records[0] : null;

                const payload = { fields: { userId: userId, stageId: parseInt(stageId), status: newStatus, Name: `User ${userId} - Stage ${stageId}` } }; // Adaloã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰Nameãªã©

                let response;
                if (existingRecord) { // æ›´æ–°
                    response = await fetch(`${ADALO_API_ENDPOINT}/${existingRecord.id}`, {
                        method: 'PUT', // ã¾ãŸã¯ PATCH
                        headers: { 'Authorization': ADALO_API_KEY, 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else { // æ–°è¦ä½œæˆ
                    response = await fetch(ADALO_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Authorization': ADALO_API_KEY, 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                userProgress[stageId] = newStatus; // ãƒ­ãƒ¼ã‚«ãƒ«ã®é€²æ—ã‚‚æ›´æ–°
                return true;
            } catch (error) {
                console.error('Failed to save user progress:', error);
                return false; // ä¿å­˜å¤±æ•—
            } finally {
                showLoading(false);
            }
            */
        }

        // --- ä¸»äººå…¬ãƒ¬ãƒ™ãƒ«æ›´æ–° ---
        function updateHeroLevel() {
            const completedCount = Object.values(userProgress).filter(status => status === 'completed').length;
            if (completedCount >= 4) heroLevel = 3;
            else if (completedCount >= 2) heroLevel = 2;
            else heroLevel = 1;
        }

        // --- ç”»é¢è¡¨ç¤ºæ›´æ–° ---
        function updateStageDisplay() {
            updateHeroLevel();
            let currentStageExists = false;

            for (let i = 1; i <= TOTAL_STAGES; i++) {
                const stageNode = document.getElementById(`stage-${i}`);
                if (!stageNode) continue;

                const status = userProgress[i] || 'locked';
                stageNode.classList.remove('completed', 'current', 'locked');
                stageNode.classList.add(status);

                // ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ±ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜ï¼‰ã‚’è¨­å®š
                const staticInfo = stageStaticData[i];
                stageNode.querySelector('.stage-title').textContent = staticInfo.title;
                stageNode.querySelector('.stage-description').textContent = staticInfo.description;

                // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã¨ã‚¯ãƒªã‚¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”»åƒã‚’è¨­å®š
                const iconImg = stageNode.querySelector('.stage-icon img.icon-image');
                const fallbackSpan = stageNode.querySelector('.stage-icon .icon-fallback');
                if (iconImg) {
                    iconImg.src = staticInfo.iconImage;
                    iconImg.style.display = 'block'; // ç”»åƒã‚’ã¾ãšè¡¨ç¤ºè©¦è¡Œ
                    fallbackSpan.style.display = 'none'; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯éš ã™
                }

                const clearEffectImg = stageNode.querySelector('.clear-effect');
                if (clearEffectImg) {
                    if (status === 'completed' && staticInfo.clearEffectImage) {
                        clearEffectImg.src = staticInfo.clearEffectImage;
                        clearEffectImg.style.display = 'block';
                    } else {
                        clearEffectImg.style.display = 'none';
                    }
                }
                
                const heroCharacter = stageNode.querySelector('.hero-character');
                if (heroCharacter) {
                    if (status === 'current') {
                        heroCharacter.style.display = 'block';
                        heroCharacter.querySelector('.hero-sprite').className = `hero-sprite hero-level-${heroLevel}`;
                        currentStageExists = true;
                    } else {
                        heroCharacter.style.display = 'none';
                    }
                }
            }
            
            // ã€Œæ¬¡ã®å†’é™ºã¸é€²ã‚€ï¼ã€ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã¨æŒ™å‹•
            if (!currentStageExists && Object.values(userProgress).every(s => s === 'completed')) {
                mainQuestButton.textContent = 'ğŸ‰ å…¨ã¦ã®å†’é™ºã‚’é”æˆï¼';
                mainQuestButton.disabled = true;
            } else {
                mainQuestButton.textContent = 'ğŸ”¥ æ¬¡ã®å†’é™ºã¸é€²ã‚€ï¼';
                mainQuestButton.disabled = false;
            }
        }

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç† ---
        function openStageModal(stageId) {
            const status = userProgress[stageId];
            if (status === 'locked') {
                alert('ã“ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã¾ã é–‹æ”¾ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼');
                return;
            }
            currentStageIdForModal = stageId;
            const staticInfo = stageStaticData[stageId];
            modalStageTitle.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¸ ${stageId}: ${staticInfo.title}`;
            modalStageDescription.textContent = staticInfo.description;
            modalStageMessage.textContent = staticInfo.message;
            
            // ã‚¯ã‚¨ã‚¹ãƒˆã«æŒ‘ã‚€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            modalQuestBtn.style.display = (status === 'current') ? 'block' : 'none';

            stageModal.style.display = 'flex';
        }

        function closeStageModal() {
            stageModal.style.display = 'none';
            currentStageIdForModal = null;
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        const hamburger = document.getElementById('hamburger');
        const sideNav = document.getElementById('sideNav');
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            sideNav.classList.toggle('active');
        });
        document.addEventListener('click', (e) => {
            if (sideNav.classList.contains('active') && !hamburger.contains(e.target) && !sideNav.contains(e.target)) {
                hamburger.classList.remove('active');
                sideNav.classList.remove('active');
            }
        });

        // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯
        document.querySelectorAll('.stage-node').forEach(node => {
            node.addEventListener('click', () => {
                const stageId = node.dataset.stageId;
                openStageModal(parseInt(stageId));
            });
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
        modalCloseBtn.addEventListener('click', closeStageModal);
        stageModal.addEventListener('click', (e) => { // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            if (e.target === stageModal) closeStageModal();
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…å‹•ç”»ã‚’è¦‹ã‚‹ãƒœã‚¿ãƒ³
        modalVideoBtn.addEventListener('click', () => {
            alert(`ã‚¹ãƒ†ãƒ¼ã‚¸ ${currentStageIdForModal} ã®å‹•ç”»ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ï¼ˆå®Ÿè£…ã¯åˆ¥é€”ï¼‰`);
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã‚¯ã‚¨ã‚¹ãƒˆã«æŒ‘ã‚€ãƒœã‚¿ãƒ³
        modalQuestBtn.addEventListener('click', async () => {
            if (!currentStageIdForModal || userProgress[currentStageIdForModal] !== 'current') return;

            const success = await saveUserProgress(currentUserId, currentStageIdForModal, 'completed');
            if (success) {
                userProgress[currentStageIdForModal] = 'completed'; // ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚æ›´æ–°
                const nextStageId = currentStageIdForModal + 1;
                if (nextStageId <= TOTAL_STAGES) {
                    const nextSuccess = await saveUserProgress(currentUserId, nextStageId, 'current');
                    if (nextSuccess) {
                         userProgress[nextStageId] = 'current'; // ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚æ›´æ–°
                    } else {
                        alert('æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®è§£æ”¾ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        // å¿…è¦ãªã‚‰ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
                    }
                }
                updateStageDisplay();
                closeStageModal();
                setTimeout(() => {
                    alert(`ã‚¹ãƒ†ãƒ¼ã‚¸ ${currentStageIdForModal} ã‚¯ãƒªã‚¢ï¼ğŸ‰ ${nextStageId <= TOTAL_STAGES ? 'æ¬¡ã®å†’é™ºã¸é€²ã‚‚ã†ï¼' : 'å…¨ã¦ã®å†’é™ºã‚’é”æˆã—ã¾ã—ãŸï¼'}`);
                }, 100);
            } else {
                alert('é€²æ—ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        });
        
        // ãƒ¡ã‚¤ãƒ³ã®ã€Œæ¬¡ã®å†’é™ºã¸é€²ã‚€ï¼ã€ãƒœã‚¿ãƒ³
        mainQuestButton.addEventListener('click', () => {
            const currentStageEntry = Object.entries(userProgress).find(([_, status]) => status === 'current');
            if (currentStageEntry) {
                openStageModal(parseInt(currentStageEntry[0]));
            } else if (Object.values(userProgress).every(s => s === 'completed')) {
                // ä½•ã‚‚ã—ãªã„ï¼ˆãƒœã‚¿ãƒ³ãŒdisabledã«ãªã£ã¦ã„ã‚‹ã¯ãšï¼‰
            } else {
                alert('å†’é™ºã‚’å§‹ã‚ã‚‹æº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            }
        });

        // å†’é™ºã®è¨˜éŒ²ãƒœã‚¿ãƒ³
        document.getElementById('adventureLogBtn').addEventListener('click', () => {
            let logText = "ğŸ“– ã“ã‚Œã¾ã§ã®å†’é™ºã®è¨˜éŒ²\n\n";
            let completedCount = 0;
            for (let i = 1; i <= TOTAL_STAGES; i++) {
                if (userProgress[i] === 'completed') {
                    logText += `ã‚¹ãƒ†ãƒ¼ã‚¸${i}: ${stageStaticData[i].title} - ã‚¯ãƒªã‚¢æ¸ˆã¿\n`;
                    completedCount++;
                } else if (userProgress[i] === 'current') {
                    logText += `ã‚¹ãƒ†ãƒ¼ã‚¸${i}: ${stageStaticData[i].title} - æŒ‘æˆ¦ä¸­\n`;
                }
            }
            if (completedCount === 0 && !Object.values(userProgress).some(s => s === 'current')) {
                logText += 'ã¾ã å†’é™ºã¯å§‹ã¾ã£ãŸã°ã‹ã‚Šã§ã™ï¼';
            }
            logText += `\nä¸»äººå…¬ãƒ¬ãƒ™ãƒ«: ${heroLevel}`;
            alert(logText);
        });

        // --- åˆæœŸåŒ–å‡¦ç† ---
        async function initializeApp() {
            currentUserId = getUserIdFromUrl();
            if (!currentUserId) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Adaloã‹ã‚‰ã®èµ·å‹•ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                // ã“ã“ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºã‚’ã™ã‚‹ã‹ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã«ã™ã‚‹ã‹ãªã©æ¤œè¨
                // ä»®ã«ã€userIdãŒãªã„å ´åˆã¯ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦é€²ã‚ã‚‹
                currentUserId = 'testUser001'; 
                console.warn('User ID not found in URL, using default testUser001');
                // return; // userIdãŒãªã„å ´åˆã¯å‡¦ç†ã‚’ä¸­æ–­ã™ã‚‹å ´åˆ
            }

            userProgress = await fetchUserProgress(currentUserId);
            updateStageDisplay();
        }

        // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
