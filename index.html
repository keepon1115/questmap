<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAFT „ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„Éó - ÂÜíÈô∫„ÅÆÊõ∏</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* „Éô„Éº„Çπ„Çπ„Çø„Ç§„É´ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        body {
            font-family: 'DotGothic16', 'M PLUS Rounded 1c', sans-serif;
            line-height: 1.6;
            color: #2c2c2c;
            overflow-x: hidden;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 50%, #B0E0E6 100%);
            min-height: 100vh;
            position: relative;
        }
        
        /* Èõ≤„ÅÆËÉåÊôØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        body::before,
        body::after {
            content: '';
            position: fixed;
            width: 100px;
            height: 40px;
            background: white;
            border-radius: 100px;
            opacity: 0.8;
            box-shadow: 
                20px 10px 0 10px white,
                -20px 10px 0 5px white;
        }
        
        body::before {
            top: 10%;
            left: -150px;
            animation: float-cloud 30s infinite linear;
        }
        
        body::after {
            top: 30%;
            right: -150px;
            animation: float-cloud-reverse 25s infinite linear;
        }
        
        @keyframes float-cloud {
            from { transform: translateX(0); }
            to { transform: translateX(calc(100vw + 300px)); }
        }
        
        @keyframes float-cloud-reverse {
            from { transform: translateX(0); }
            to { transform: translateX(calc(-100vw - 300px)); }
        }
        
        /* „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„ÉºÔºà„Éî„ÇØ„Çª„É´„Ç¢„Éº„ÉàÈ¢®Ôºâ */
        .hamburger {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            width: 48px;
            height: 48px;
            background: #8B4513;
            border: 3px solid #654321;
            border-radius: 0;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 6px;
            transition: transform 0.1s ease;
            box-shadow: 
                0 0 0 1px #A0522D,
                3px 3px 0 0 rgba(0,0,0,0.3);
        }
        
        .hamburger:hover {
            transform: translate(-1px, -1px);
            box-shadow: 
                0 0 0 1px #A0522D,
                4px 4px 0 0 rgba(0,0,0,0.3);
        }
        
        .hamburger:active {
            transform: translate(1px, 1px);
            box-shadow: 
                0 0 0 1px #A0522D,
                2px 2px 0 0 rgba(0,0,0,0.3);
        }
        
        .hamburger span {
            width: 24px;
            height: 4px;
            background: #F5DEB3;
            border-radius: 0;
            transition: all 0.3s ease;
        }
        
        /* „Çµ„Ç§„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .side-nav {
            position: fixed;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100vh;
            background: #2C1810;
            border-right: 4px solid #654321;
            z-index: 999;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            padding: 80px 20px 20px;
        }
        
        @media (min-width: 768px) {
            .side-nav {
                width: 280px;
            }
        }
        
        .side-nav.active {
            left: 0;
        }
        
        .side-nav-item {
            padding: 16px 20px;
            margin: 8px 0;
            background: #3D2817;
            border: 2px solid #654321;
            cursor: pointer;
            transition: all 0.1s ease;
            font-weight: 500;
            color: #F5DEB3;
            text-align: center;
            position: relative;
            box-shadow: 2px 2px 0 0 rgba(0,0,0,0.5);
        }
        
        .side-nav-item:hover {
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 0 rgba(0,0,0,0.5);
            background: #4D3827;
        }
        
        .side-nav-item:active {
            transform: translate(0, 0);
            box-shadow: 1px 1px 0 0 rgba(0,0,0,0.5);
        }
        
        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 80px 16px 40px;
            position: relative;
            z-index: 10;
        }
        
        /* „Éò„ÉÉ„ÉÄ„Éº */
        .map-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .map-header h1 {
            font-size: 2.5rem;
            color: #FFF;
            margin-bottom: 16px;
            text-shadow: 
                2px 2px 0 #4DB6F7,
                4px 4px 0 #3A8BC4,
                6px 6px 8px rgba(0,0,0,0.3);
            letter-spacing: 2px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .map-header p {
            font-size: 1.1rem;
            color: #FFF;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.2);
            display: inline-block;
            padding: 4px 16px;
            border-radius: 0;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        /* ÂÜíÈô∫„ÅÆË®òÈå≤„Éú„Çø„É≥ */
        .adventure-log-button {
            display: inline-block;
            margin: 20px auto 0;
            padding: 12px 32px;
            background: #FFD700;
            border: 3px solid #B8860B;
            color: #654321;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            position: relative;
            box-shadow: 
                0 0 0 1px #DAA520,
                4px 4px 0 0 rgba(0,0,0,0.3);
            transition: all 0.1s ease;
        }
        
        .adventure-log-button::before {
            content: 'üìñ';
            margin-right: 8px;
        }
        
        .adventure-log-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 
                0 0 0 1px #DAA520,
                6px 6px 0 0 rgba(0,0,0,0.3);
        }
        
        .adventure-log-button:active {
            transform: translate(1px, 1px);
            box-shadow: 
                0 0 0 1px #DAA520,
                2px 2px 0 0 rgba(0,0,0,0.3);
        }
        
        /* „Çπ„ÉÜ„Éº„Ç∏„Ç∞„É™„ÉÉ„Éâ */
        .stage-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 32px;
            margin-bottom: 40px;
            padding: 0 20px;
        }
        
        @media (max-width: 767px) {
            .stage-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 24px;
                padding: 0;
            }
        }
        
        /* „Çπ„ÉÜ„Éº„Ç∏„Éé„Éº„Éâ */
        .stage-node {
            position: relative;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .stage-node:nth-child(2),
        .stage-node:nth-child(5) {
            transform: translateY(40px);
        }
        
        @media (max-width: 767px) {
            .stage-node:nth-child(even) {
                transform: translateY(40px);
            }
            .stage-node:nth-child(5) {
                transform: translateY(0);
            }
        }
        
        .stage-node:hover {
            transform: translateY(-5px) scale(1.05);
        }
        
        .stage-node:nth-child(2):hover,
        .stage-node:nth-child(5):hover {
            transform: translateY(35px) scale(1.05);
        }
        
        @media (max-width: 767px) {
            .stage-node:nth-child(even):hover {
                transform: translateY(35px) scale(1.05);
            }
            .stage-node:nth-child(5):hover {
                transform: translateY(-5px) scale(1.05);
            }
        }
        
        /* „Çπ„ÉÜ„Éº„Ç∏„Ç¢„Ç§„Ç≥„É≥ */
        .stage-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 16px;
            position: relative;
            background: #E8F5E9;
            border: 4px solid #333;
            box-shadow: 
                0 0 0 2px #666,
                6px 6px 0 0 rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px; /* „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁµµÊñáÂ≠óÁî® */
            transition: all 0.3s ease;
            overflow: hidden; /* „Ç®„Éï„Çß„ÇØ„ÉàÁîªÂÉè„Åå„ÅØ„ÅøÂá∫„Å™„ÅÑ„Çà„ÅÜ„Å´ */
        }
        
        .stage-node.locked .stage-icon {
            background: #9E9E9E;
            filter: grayscale(1);
            opacity: 0.7;
        }
        
        .stage-node.completed .stage-icon {
            background: #FFF9C4;
            box-shadow: 
                0 0 0 2px #FFD700,
                6px 6px 0 0 rgba(0,0,0,0.3),
                0 0 20px rgba(255,215,0,0.5);
        }
        
        /* „Çπ„ÉÜ„Éº„Ç∏„Ç¢„Ç§„Ç≥„É≥ÁîªÂÉè */
        .stage-icon img.icon-image { /* „ÇØ„É©„ÇπÂêçÂ§âÊõ¥ */
            width: 64px; /* „Çµ„Ç§„Ç∫ÊåáÂÆö„ÅØ„Åì„Åì„ÅßË°å„ÅÜ */
            height: 64px;
            object-fit: contain; /* „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„Çí‰øù„Å§ */
            image-rendering: pixelated;
            display: block; /* ÊúÄÂàù„ÅØË°®Á§∫„ÄÅJS„Åß„Ç®„É©„ÉºÊôÇÈùûË°®Á§∫„Å´ */
        }
        
        .stage-icon .icon-fallback {
            font-size: 64px;
            display: none; /* ÊúÄÂàù„ÅØÈùûË°®Á§∫„ÄÅÁîªÂÉè„Ç®„É©„ÉºÊôÇ„Å´JS„ÅßË°®Á§∫ */
        }
        
        /* „ÇØ„É™„Ç¢ÊºîÂá∫ÁîªÂÉè */
        .clear-effect {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            object-fit: contain;
            display: none; /* JS„ÅßcompletedÊôÇ„Å´Ë°®Á§∫ */
            z-index: 2;
            animation: effect-animation 2s ease-in-out infinite; /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅØÂÖ±ÈÄö„ÅßËâØ„ÅÑ„ÅãÊ§úË®é */
        }
        
        /* ÂÄãÂà•„ÅÆ„ÇØ„É™„Ç¢„Ç®„Éï„Çß„ÇØ„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÔºàÂøÖË¶Å„Å™„ÇâÔºâ */
        /* .clear-effect.smoke { animation: smoke-animation 2s infinite; } */
        /* .clear-effect.animal { animation: animal-animation 3s infinite; } */
        
        .stage-node.completed .clear-effect {
            display: block;
        }
        
        @keyframes effect-animation { /*Ê±éÁî®ÁöÑ„Å™„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰æã*/
            0%, 100% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0.9; }
            25% { transform: translateY(-5px) scale(1.1) rotate(5deg); opacity: 1; }
            50% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0.9; }
            75% { transform: translateY(-3px) scale(1.05) rotate(-5deg); opacity: 1; }
        }
        
        /* CLEAR„Éê„ÉÉ„Ç∏ */
        .clear-badge {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: #FFD700;
            border: 3px solid #B8860B;
            padding: 4px 12px;
            font-weight: bold;
            font-size: 14px;
            color: #654321;
            letter-spacing: 1px;
            box-shadow: 
                0 0 0 1px #DAA520,
                3px 3px 0 0 rgba(0,0,0,0.5);
            z-index: 10;
            animation: bounce-in 0.5s ease;
            display: none;
        }
        
        .stage-node.completed .clear-badge {
            display: block;
        }
        
        @keyframes bounce-in {
            0% { transform: translateX(-50%) translateY(-20px) scale(0); }
            50% { transform: translateX(-50%) translateY(0) scale(1.2); }
            100% { transform: translateX(-50%) translateY(0) scale(1); }
        }
        
        /* „Çπ„ÉÜ„Éº„Ç∏Áï™Âè∑„Éê„ÉÉ„Ç∏ */
        .stage-number-badge {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: #4DB6F7;
            border: 3px solid #2C88C7;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Â∑¶ÊèÉ„Åà */
            padding-left: 12px; /* Â∑¶„ÅÆ‰ΩôÁôΩ */
            font-size: 20px;
            font-weight: bold;
            color: white;
            box-shadow: 
                0 0 0 1px #5AC8F7,
                3px 3px 0 0 rgba(0,0,0,0.3);
            z-index: 5;
        }
        
        .stage-node.locked .stage-number-badge {
            background: #757575;
            border-color: #616161;
            box-shadow: 
                0 0 0 1px #9E9E9E,
                3px 3px 0 0 rgba(0,0,0,0.3);
        }
        
        /* ‰∏ª‰∫∫ÂÖ¨„Ç≠„É£„É©„ÇØ„Çø„Éº */
        .hero-character {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 48px;
            height: 48px;
            z-index: 20;
            animation: hero-idle 0.8s steps(2) infinite;
            display: none; /* JS„ÅßcurrentÊôÇ„Å´Ë°®Á§∫ */
        }
        
        .stage-node.current .hero-character {
            display: block;
        }
        
        @keyframes hero-idle {
            0% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-2px); }
        }
        
        /* ‰∏ª‰∫∫ÂÖ¨„ÅÆË¶ã„ÅüÁõÆÔºàCSS „Çπ„Éó„É©„Ç§„ÉàÈ¢®Ôºâ */
        .hero-sprite {
            width: 100%;
            height: 100%;
            background-size: 48px 48px; /* CSS„Çπ„Éó„É©„Ç§„ÉàÁîªÂÉè„Åå„ÅÇ„Çã„Å™„Çâ„Åù„ÅÆÂÖ®‰Ωì„ÅÆ„Çµ„Ç§„Ç∫ */
            image-rendering: pixelated;
            /* background-image: url('path/to/hero-spritesheet.png'); */ /* „Çπ„Éó„É©„Ç§„Éà„Ç∑„Éº„Éà„Çí‰Ωø„ÅÜÂ†¥Âêà */
        }
        
        /* ‰ª•‰∏ã„ÅØCSS„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„Åß„ÅÆË°®Áèæ‰æã„ÄÇÁîªÂÉè„Çí‰Ωø„ÅÜÂ†¥Âêà„ÅØ‰∏çË¶Å„Å´„Å™„Çã„Åã„ÄÅ„Çπ„Éó„É©„Ç§„Éà„ÅÆbackground-position„ÅßÂà∂Âæ° */
        .hero-level-1 {
            background: 
                linear-gradient(to right, transparent 45%, #8B4513 45%, #8B4513 55%, transparent 55%),
                linear-gradient(to bottom, #F4A460 0%, #F4A460 30%, #4169E1 30%, #4169E1 70%, #8B4513 70%);
            /* background-position: 0 0; „Çπ„Éó„É©„Ç§„Éà„ÅÆÂ†¥Âêà */
        }
        
        .hero-level-2 {
            background: 
                linear-gradient(to bottom, #FF0000 0%, #FF0000 15%, transparent 15%),
                linear-gradient(to right, transparent 45%, #8B4513 45%, #8B4513 55%, transparent 55%),
                linear-gradient(to bottom, #F4A460 15%, #F4A460 35%, #4169E1 35%, #4169E1 70%, #8B4513 70%);
            /* background-position: -48px 0; „Çπ„Éó„É©„Ç§„Éà„ÅÆÂ†¥Âêà */
        }
        
        .hero-level-3 {
            background: 
                linear-gradient(to right, transparent 70%, #C0C0C0 70%, #C0C0C0 75%, transparent 75%),
                linear-gradient(to bottom, #FF0000 0%, #FF0000 15%, transparent 15%),
                linear-gradient(to right, transparent 45%, #8B4513 45%, #8B4513 55%, transparent 55%),
                linear-gradient(to bottom, #F4A460 15%, #F4A460 35%, #32CD32 35%, #32CD32 70%, #8B4513 70%);
            /* background-position: -96px 0; „Çπ„Éó„É©„Ç§„Éà„ÅÆÂ†¥Âêà */
        }
        
        /* „Çπ„ÉÜ„Éº„Ç∏ÊÉÖÂ†± */
        .stage-info {
            background: white;
            border: 3px solid #333;
            padding: 12px 16px;
            margin-top: 16px;
            position: relative;
            box-shadow: 
                0 0 0 1px #666,
                4px 4px 0 0 rgba(0,0,0,0.2);
        }
        
        .stage-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        
        .stage-description {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }
        
        /* „Éë„Çπ„É©„Ç§„É≥ÔºàÈÅìÔºâ */
        .path-line {
            position: absolute;
            width: 60px;
            height: 4px;
            background: repeating-linear-gradient(
                90deg,
                #8B4513,
                #8B4513 10px,
                #D2691E 10px,
                #D2691E 20px
            );
            top: 50%; /* „Ç¢„Ç§„Ç≥„É≥„ÅÆ‰∏≠ÂøÉ„Å´Âêà„Çè„Åõ„Çã„Åü„ÇÅË™øÊï¥„ÅåÂøÖË¶Å„Åã„ÇÇ */
            right: -60px; /* stage-node„ÅÆÂè≥Á´Ø„Åã„ÇâÂ§ñ„Å∏ */
            transform: translateY(-50%);
            z-index: 1;
        }
        
        .stage-node:nth-child(3n) .path-line, /* ÂêÑË°å„ÅÆÊúÄÂæå„ÅÆË¶ÅÁ¥† */
        .stage-node:last-child .path-line { /* „Ç∞„É™„ÉÉ„ÉâÂÖ®‰Ωì„ÅÆÊúÄÂæå„ÅÆË¶ÅÁ¥† */
            display: none;
        }
        
        @media (max-width: 767px) {
            .stage-node:nth-child(3n) .path-line { display: block; } /* 3ÂàóÁõÆ„ÅÆ„Éë„ÇπË°®Á§∫„Çí„É™„Çª„ÉÉ„Éà */
            .stage-node:nth-child(2n) .path-line, /* SP„Åß„ÅØÂêÑË°å„ÅÆÊúÄÂæå„ÅÆË¶ÅÁ¥† */
            .stage-node:last-child .path-line {
                display: none;
            }
        }
        
        /* „ÇØ„Ç®„Çπ„Éà„Éú„Çø„É≥ */
        .quest-button {
            display: block;
            width: fit-content;
            margin: 40px auto;
            padding: 16px 48px;
            background: #FF6B6B;
            border: 4px solid #DC143C;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            box-shadow: 
                0 0 0 2px #FF8787,
                6px 6px 0 0 rgba(0,0,0,0.3);
            transition: all 0.1s ease;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .quest-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 
                0 0 0 2px #FF8787,
                8px 8px 0 0 rgba(0,0,0,0.3);
            animation: none;
        }
        
        .quest-button:active {
            transform: translate(2px, 2px);
            box-shadow: 
                0 0 0 2px #FF8787,
                2px 2px 0 0 rgba(0,0,0,0.3);
        }
        
        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            align-items: center; /* Flexbox„Åß‰∏≠Â§ÆÊèÉ„Åà */
            justify-content: center; /* Flexbox„Åß‰∏≠Â§ÆÊèÉ„Åà */
        }
        
        .modal-content {
            /* position, top, left, transform „ÅØFlexbox‰∏≠Â§ÆÊèÉ„Åà„ÅÆ„Åü„ÇÅ‰∏çË¶Å„Å´ */
            background: #F5F5DC;
            border: 4px solid #8B4513;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 
                0 0 0 2px #A0522D,
                8px 8px 0 0 rgba(0,0,0,0.5);
            position: relative; /* „ÇØ„É≠„Éº„Ç∫„Éú„Çø„É≥„ÅÆÂü∫Ê∫ñ„ÅÆ„Åü„ÇÅ */
        }
        
        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: #DC143C;
            border: 2px solid #8B0000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            font-weight: bold;
            box-shadow: 2px 2px 0 0 rgba(0,0,0,0.5);
        }
        
        .modal-close:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 0 rgba(0,0,0,0.5);
        }
        
        .modal-close:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 0 rgba(0,0,0,0.5);
        }
        
        .modal-title {
            font-size: 1.6rem;
            color: #8B4513;
            margin-bottom: 16px;
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
        }
        
        .modal-description {
            color: #654321;
            margin-bottom: 20px;
            line-height: 1.6;
            text-align: center;
        }
        
        .modal-message {
            background: #FFF9C4;
            border: 2px solid #F9A825;
            padding: 16px;
            margin-bottom: 24px;
            text-align: center;
            font-style: italic;
            color: #5D4037;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.1);
        }
        
        .modal-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
        }
        
        @media (max-width: 767px) {
            .modal-buttons {
                flex-direction: column;
            }
        }
        
        .modal-button {
            flex: 1;
            padding: 12px 24px;
            border: 3px solid;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s ease;
            position: relative;
        }
        
        .modal-button.video {
            background: #4CAF50;
            border-color: #388E3C;
            color: white;
            box-shadow: 
                0 0 0 1px #66BB6A,
                4px 4px 0 0 rgba(0,0,0,0.3);
        }
        
        .modal-button.video:hover {
            transform: translate(-2px, -2px);
            box-shadow: 
                0 0 0 1px #66BB6A,
                6px 6px 0 0 rgba(0,0,0,0.3);
        }
        
        .modal-button.quest {
            background: #2196F3;
            border-color: #1976D2;
            color: white;
            box-shadow: 
                0 0 0 1px #42A5F5,
                4px 4px 0 0 rgba(0,0,0,0.3);
        }
        
        .modal-button.quest:hover {
            transform: translate(-2px, -2px);
            box-shadow: 
                0 0 0 1px #42A5F5,
                6px 6px 0 0 rgba(0,0,0,0.3);
        }
        
        .modal-button:active {
            transform: translate(1px, 1px);
            box-shadow: 
                0 0 0 1px currentColor, /* Ëá™Ë∫´„ÅÆËÉåÊôØËâ≤„ÅßÂÖâ„Çã„Çà„ÅÜ„Å´ */
                2px 2px 0 0 rgba(0,0,0,0.3);
        }
        
        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ */
        .loading-overlay { /* ÂêçÁß∞Â§âÊõ¥ */
            display: none; /* JS„ÅßÂà∂Âæ° */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5); /* ÂçäÈÄèÊòéËÉåÊôØ */
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .loading-content { /* „Ç≥„É≥„ÉÜ„ÉäËøΩÂä† */
            text-align: center;
            background: #F5F5DC;
            padding: 30px;
            border: 4px solid #8B4513;
            box-shadow: 
                0 0 0 2px #A0522D,
                8px 8px 0 0 rgba(0,0,0,0.5);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4DB6F7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-content p {
            color: #654321;
            font-weight: bold;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>ÂÜíÈô∫„ÅÆÊ∫ñÂÇô‰∏≠...</p>
        </div>
    </div>
    
    <!-- „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº -->
    <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
    </div>
    
    <!-- „Çµ„Ç§„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
    <nav class="side-nav" id="sideNav">
        <div class="side-nav-item">üè† „Éõ„Éº„É†</div>
        <div class="side-nav-item">‚öîÔ∏è „Ç∏„Éñ„É≥„ÇØ„É©„Éï„Éà</div>
        <div class="side-nav-item">üó∫Ô∏è „ÇØ„Ç®„Çπ„Éà</div>
        <div class="side-nav-item">üåç Yononaka</div>
        <div class="side-nav-item">üöÄ „Éü„É©„Ç§„ÇØ„É©„Éï„Éà</div>
    </nav>
    
    <div class="container">
        <header class="map-header">
            <h1>üó∫Ô∏è CLAFT „ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„Éó</h1>
            <p>„Åç„Åø„Å†„Åë„ÅÆÂÜíÈô∫Áâ©Ë™û„Çí„Å§„Åè„Çç„ÅÜÔºÅ</p>
            <button class="adventure-log-button" id="adventureLogBtn">
                „Åì„Çå„Åæ„Åß„ÅÆÂÜíÈô∫„ÇíÊåØ„ÇäËøî„Çã
            </button>
        </header>
        
        <div class="stage-grid" id="stageGrid">
            <!-- „Çπ„ÉÜ„Éº„Ç∏1 -->
            <div class="stage-node" id="stage-1" data-stage-id="1">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character">
                    <div class="hero-sprite hero-level-1"></div>
                </div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/8B4513/FFFFFF?text=House" alt="„Çπ„ÉÜ„Éº„Ç∏1„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üè†</span>
                    <img class="clear-effect" src="https://via.placeholder.com/32x32/CCCCCC/000000?text=Smoke" alt="ÁÖô„Ç®„Éï„Çß„ÇØ„Éà" data-effect-type="smoke">
                </div>
                <div class="stage-number-badge">1</div>
                <div class="stage-info">
                    <h3 class="stage-title"></h3> <!-- JS„ÅßË®≠ÂÆö -->
                    <p class="stage-description"></p> <!-- JS„ÅßË®≠ÂÆö -->
                </div>
                <div class="path-line"></div>
            </div>
            
            <!-- „Çπ„ÉÜ„Éº„Ç∏2 -->
            <div class="stage-node" id="stage-2" data-stage-id="2">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character">
                    <div class="hero-sprite hero-level-1"></div>
                </div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/228B22/FFFFFF?text=Forest" alt="„Çπ„ÉÜ„Éº„Ç∏2„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üå≤</span>
                    <img class="clear-effect" src="https://via.placeholder.com/32x32/8B4513/FFFFFF?text=Animal" alt="ÂãïÁâ©„Ç®„Éï„Çß„ÇØ„Éà" data-effect-type="animal">
                </div>
                <div class="stage-number-badge">2</div>
                <div class="stage-info">
                    <h3 class="stage-title"></h3>
                    <p class="stage-description"></p>
                </div>
                <div class="path-line"></div>
            </div>
            
            <!-- „Çπ„ÉÜ„Éº„Ç∏3 -->
            <div class="stage-node" id="stage-3" data-stage-id="3">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character">
                    <div class="hero-sprite hero-level-1"></div>
                </div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/4169E1/FFFFFF?text=Sword" alt="„Çπ„ÉÜ„Éº„Ç∏3„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">‚öîÔ∏è</span>
                    <!-- No clear effect for this stage in the example -->
                </div>
                <div class="stage-number-badge">3</div>
                <div class="stage-info">
                    <h3 class="stage-title"></h3>
                    <p class="stage-description"></p>
                </div>
                <div class="path-line"></div>
            </div>
            
            <!-- „Çπ„ÉÜ„Éº„Ç∏4 -->
            <div class="stage-node" id="stage-4" data-stage-id="4">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character">
                    <div class="hero-sprite hero-level-1"></div>
                </div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/FFD700/000000?text=Shield" alt="„Çπ„ÉÜ„Éº„Ç∏4„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üõ°Ô∏è</span>
                </div>
                <div class="stage-number-badge">4</div>
                <div class="stage-info">
                    <h3 class="stage-title"></h3>
                    <p class="stage-description"></p>
                </div>
                <div class="path-line"></div>
            </div>
            
            <!-- „Çπ„ÉÜ„Éº„Ç∏5 -->
            <div class="stage-node" id="stage-5" data-stage-id="5">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character">
                    <div class="hero-sprite hero-level-1"></div>
                </div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/32CD32/FFFFFF?text=Team" alt="„Çπ„ÉÜ„Éº„Ç∏5„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üë•</span>
                </div>
                <div class="stage-number-badge">5</div>
                <div class="stage-info">
                    <h3 class="stage-title"></h3>
                    <p class="stage-description"></p>
                </div>
                <div class="path-line"></div>
            </div>
            
            <!-- „Çπ„ÉÜ„Éº„Ç∏6 -->
            <div class="stage-node" id="stage-6" data-stage-id="6">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-character">
                    <div class="hero-sprite hero-level-1"></div>
                </div>
                <div class="stage-icon">
                    <img class="icon-image" src="https://via.placeholder.com/64x64/8B0000/FFFFFF?text=Boss" alt="„Çπ„ÉÜ„Éº„Ç∏6„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üè∞</span>
                </div>
                <div class="stage-number-badge">6</div>
                <div class="stage-info">
                    <h3 class="stage-title"></h3>
                    <p class="stage-description"></p>
                </div>
                <!-- No path-line for the last stage -->
            </div>
        </div>
        
        <button class="quest-button" id="mainQuestButton">üî• Ê¨°„ÅÆÂÜíÈô∫„Å∏ÈÄ≤„ÇÄÔºÅ</button>
    </div>
    
    <!-- „É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="stageModal">
        <div class="modal-content">
            <button class="modal-close" id="modalCloseBtn">√ó</button>
            <h2 class="modal-title" id="modalStageTitle"></h2>
            <p class="modal-description" id="modalStageDescription"></p>
            <div class="modal-message" id="modalStageMessage"></div>
            <div class="modal-buttons">
                <button class="modal-button video" id="modalVideoBtn">üé¨ ÂãïÁîª„ÇíË¶ã„Çã</button>
                <button class="modal-button quest" id="modalQuestBtn">‚öîÔ∏è „ÇØ„Ç®„Çπ„Éà„Å´Êåë„ÇÄ</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- „Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆö ---
        const ADALO_API_ENDPOINT = 'YOUR_ADALO_ENDPOINT/collections/YOUR_PROGRESS_COLLECTION_ID'; // ‰æã: https://api.adalo.com/v0/apps/YOUR_APP_ID/collections/YOUR_COLLECTION_ID
        const ADALO_API_KEY = 'Bearer YOUR_ADALO_API_KEY';
        const TOTAL_STAGES = 6;

        // „Çπ„ÉÜ„Éº„Ç∏„ÅÆÈùôÁöÑÊÉÖÂ†±Ôºà„Çø„Ç§„Éà„É´„ÄÅË™¨Êòé„ÄÅ„É°„ÉÉ„Çª„Éº„Ç∏Ôºâ
        // „Ç¢„Ç§„Ç≥„É≥ÁîªÂÉèURL„ÇÑ„ÇØ„É™„Ç¢„Ç®„Éï„Çß„ÇØ„ÉàÁîªÂÉèURL„ÇÇ„Åì„Åì„Å´ÂÆöÁæ©„Åô„Çã„Å®ÁÆ°ÁêÜ„Åó„ÇÑ„Åô„ÅÑ
        const stageStaticData = {
            1: {
                title: 'Âêõ„ÅØ„Å©„Çì„Å™ÂÜíÈô∫ËÄÖÔºü',
                description: '„Åì„ÅÆ‰∏ñÁïå„ÅÆÂú∞Âõ≥„Çí„Å≤„Çâ„ÅÑ„Å¶„ÄÅCLAFT„ÇíÂÜíÈô∫„Åó„Çà„ÅÜÔºÅ',
                message: '„Äå„Åì„ÅÆ‰∏ñÁïå„Çí„Å©„ÅÜÊ≠©„Åè„Åã„ÅØ„ÄÅËá™ÂàÜ„ÅßÊ±∫„ÇÅ„Å¶„ÅÑ„ÅÑ„Äç',
                iconImage: 'https://via.placeholder.com/64x64/8B4513/FFFFFF?text=House',
                clearEffectImage: 'https://via.placeholder.com/32x32/CCCCCC/000000?text=Smoke'
            },
            2: {
                title: '„ÉØ„ÇØ„ÇÇ„ÇÑ„Ç®„Éç„É´„ÇÆ„Éº',
                description: '„ÉØ„ÇØ„ÉØ„ÇØ„Éª„ÇÇ„ÇÑ„ÇÇ„ÇÑ„ÅØÂïè„ÅÑ„ÅÆÂéüÂãïÂäõ„Å´„Å™„Çã',
                message: '„ÄåÂêõ„ÅÆÊÑü„Åò„Åü"„ÇÇ„ÇÑ„ÇÇ„ÇÑ"„Åå„ÄÅÂÜíÈô∫„ÅÆÂá∫Áô∫ÁÇπ„Äç',
                iconImage: 'https://via.placeholder.com/64x64/228B22/FFFFFF?text=Forest',
                clearEffectImage: 'https://via.placeholder.com/32x32/8B4513/FFFFFF?text=Animal'
            },
            3: {
                title: 'Âêõ„ÅØ„Å©„Çì„Å™„Ç≠„É£„É©Ôºü',
                description: 'Ëá™ÂàÜ„ÇíËÇ≤„Å¶„ÇãËÇ≤Êàê„Ç≤„Éº„É†',
                message: '„ÄåËá™ÂàÜ„ÅÆ„Çπ„Ç≠„É´„ÉÑ„É™„Éº„ÇíËÇ≤„Å¶„Çã„ÅÆ„ÅØ„ÄÅÂêõËá™Ë∫´„Å†„Äç',
                iconImage: 'https://via.placeholder.com/64x64/4169E1/FFFFFF?text=Sword',
                clearEffectImage: null // „Åì„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅØ„Ç®„Éï„Çß„ÇØ„Éà„Å™„Åó
            },
            4: {
                title: '„Å©„Çì„Å™ÈÅìÂÖ∑„ÇíÊåÅ„Å£„Å¶„ÇãÔºü',
                description: '„Åì„ÅÆ‰∏ñÁïå„ÅÆÂú∞Âõ≥„Çí„Å≤„Çâ„ÅÑ„Å¶„ÄÅCLAFT„ÇíÂÜíÈô∫„Åó„Çà„ÅÜÔºÅ',
                message: '„ÄåËá™ÂàÜ„ÅÆ„Çπ„Ç≠„É´„ÉÑ„É™„Éº„ÇíËÇ≤„Å¶„Çã„ÅÆ„ÅØ„ÄÅÂêõËá™Ë∫´„Å†„Äç',
                iconImage: 'https://via.placeholder.com/64x64/FFD700/000000?text=Shield',
                clearEffectImage: null
            },
            5: {
                title: '‰ª≤Èñì„Å®ÂÜíÈô∫„Åô„Çã„Å£„Å¶Ôºü',
                description: '„Åì„ÅÆ‰∏ñÁïå„ÅÆÂú∞Âõ≥„Çí„Å≤„Çâ„ÅÑ„Å¶„ÄÅCLAFT„ÇíÂÜíÈô∫„Åó„Çà„ÅÜÔºÅ',
                message: '„ÄåËá™ÂàÜ„ÅÆ„Çπ„Ç≠„É´„ÉÑ„É™„Éº„ÇíËÇ≤„Å¶„Çã„ÅÆ„ÅØ„ÄÅÂêõËá™Ë∫´„Å†„Äç',
                iconImage: 'https://via.placeholder.com/64x64/32CD32/FFFFFF?text=Team',
                clearEffectImage: null
            },
            6: {
                title: 'Êú™Êù•„ÅÆ„Éú„Çπ„Å®Âêë„ÅçÂêà„ÅÜ',
                description: '„Åì„ÅÆ‰∏ñÁïå„ÅÆÂú∞Âõ≥„Çí„Å≤„Çâ„ÅÑ„Å¶„ÄÅCLAFT„ÇíÂÜíÈô∫„Åó„Çà„ÅÜÔºÅ',
                message: '„ÄåËá™ÂàÜ„ÅÆ„Çπ„Ç≠„É´„ÉÑ„É™„Éº„ÇíËÇ≤„Å¶„Çã„ÅÆ„ÅØ„ÄÅÂêõËá™Ë∫´„Å†„Äç',
                iconImage: 'https://via.placeholder.com/64x64/8B0000/FFFFFF?text=Boss',
                clearEffectImage: null
            }
        };

        // --- DOMË¶ÅÁ¥†ÂèñÂæó ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const stageGrid = document.getElementById('stageGrid');
        const mainQuestButton = document.getElementById('mainQuestButton');
        const stageModal = document.getElementById('stageModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalStageTitle = document.getElementById('modalStageTitle');
        const modalStageDescription = document.getElementById('modalStageDescription');
        const modalStageMessage = document.getElementById('modalStageMessage');
        const modalVideoBtn = document.getElementById('modalVideoBtn');
        const modalQuestBtn = document.getElementById('modalQuestBtn');
        
        let currentUserId = null;
        let userProgress = {}; // { 1: 'completed', 2: 'current', 3: 'locked', ... }
        let heroLevel = 1;
        let currentStageIdForModal = null;


        // --- „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ ---
        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        // --- „É¶„Éº„Ç∂„ÉºIDÂèñÂæó ---
        function getUserIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('userId');
        }

        // --- Adalo APIÈÄ£Êê∫ („Çπ„Çø„Éñ) ---
        async function fetchUserProgress(userId) {
            showLoading(true);
            console.log(`Fetching progress for userId: ${userId}`);
            // --- „Çπ„Çø„ÉñÂÆüË£Ö ---
            // Adalo„Åß„ÅØ„ÄÅÁâπÂÆö„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆÈÄ≤Êçó„É¨„Ç≥„Éº„Éâ„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Åó„Å¶ÂèñÂæó„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ
            // ‰æã: GET ${ADALO_API_ENDPOINT}?filter[userId]=${userId}
            // ÂÆüÈöõ„Å´„ÅØfetch API„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ
            return new Promise(resolve => {
                setTimeout(() => {
                    // „ÉÄ„Éü„Éº„Éá„Éº„Çø: Adalo API„Åã„ÇâËøî„Åï„Çå„Çã„É¨„Ç≥„Éº„Éâ„ÅÆÈÖçÂàó„ÇíÊÉ≥ÂÆö
                    // ÂàùÂõû„É¶„Éº„Ç∂„Éº„ÅÆÂ†¥Âêà„ÄÅÁ©∫„ÅÆÈÖçÂàó„ÅåËøî„Çã„Åã„ÄÅË©≤ÂΩì„É¨„Ç≥„Éº„Éâ„Åå„Å™„ÅÑ„Åì„Å®„ÇíÊÉ≥ÂÆö
                    const dummyApiResponse = [
                        // { "id": "rec_abc", "userId": userId, "stageId": 1, "status": "completed", "Name": `Progress ${userId}-1`}, // Adalo„ÅÆ„É¨„Ç≥„Éº„ÉâÂΩ¢Âºè„Å´Âêà„Çè„Åõ„Çã
                        // { "id": "rec_def", "userId": userId, "stageId": 2, "status": "current", "Name": `Progress ${userId}-2`}
                    ];
                    
                    const progress = {};
                    for (let i = 1; i <= TOTAL_STAGES; i++) {
                        const record = dummyApiResponse.find(r => r.stageId === i);
                        progress[i] = record ? record.status : (i === 1 ? 'current' : 'locked'); // ÂàùÂõû„ÅØ„Çπ„ÉÜ„Éº„Ç∏1„Ååcurrent
                    }
                    // „ÇÇ„Åó„É¨„Ç≥„Éº„Éâ„ÅåÔºë„Å§„ÇÇ„Å™„Åë„Çå„Å∞„ÄÅ„Çπ„ÉÜ„Éº„Ç∏1„Çícurrent, „Åù„Çå‰ª•Â§ñ„Çílocked„Å®„Åô„Çã
                    if (dummyApiResponse.length === 0) {
                        progress[1] = 'current';
                        for (let i = 2; i <= TOTAL_STAGES; i++) {
                            progress[i] = 'locked';
                        }
                    }

                    console.log('Dummy progress fetched:', progress);
                    showLoading(false);
                    resolve(progress);
                }, 1000); // 1Áßí„ÅÆÈÅÖÂª∂„Çí„Ç∑„Éü„É•„É¨„Éº„Éà
            });
            // --- ÂÆüÈöõ„ÅÆfetch„ÅÆ‰æã ---
            /*
            try {
                const response = await fetch(`${ADALO_API_ENDPOINT}?filter[userId]=${userId}`, { // Adalo„ÅÆ„Éï„Ç£„É´„ÇøÊßãÊñá„Å´Ê≥®ÊÑè
                    method: 'GET',
                    headers: {
                        'Authorization': ADALO_API_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json(); // Adalo„ÅØ records: [] „ÅÆÂΩ¢„ÅßËøî„Åô„Åì„Å®„ÅåÂ§ö„ÅÑ
                
                const progress = {};
                for (let i = 1; i <= TOTAL_STAGES; i++) {
                    // Adalo„ÅÆ„É¨„Ç≥„Éº„Éâ„Åã„ÇâË©≤ÂΩì„Çπ„ÉÜ„Éº„Ç∏„ÅÆstatus„ÇíÊé¢„Åô
                    // Adalo„Åß„ÅØÈÄöÂ∏∏„ÄÅ„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„ÅÆÂÖ®„É¨„Ç≥„Éº„Éâ„Åã„ÄÅ„Éï„Ç£„É´„Çø„Åï„Çå„Åü„É¨„Ç≥„Éº„Éâ„ÅåËøî„Å£„Å¶„Åè„Çã
                    // „É¶„Éº„Ç∂„Éº„Åî„Å®„Å´ÈÄ≤Êçó„É¨„Ç≥„Éº„Éâ„Çí‰ΩúÊàê„ÉªÊõ¥Êñ∞„Åô„ÇãÈÅãÁî®„ÇíÊÉ≥ÂÆö
                    const record = data.records.find(r => r.fields.stageId === i && r.fields.userId === userId); // Adalo„ÅÆ„Éï„Ç£„Éº„É´„ÉâÂêç„Å´Âêà„Çè„Åõ„Çã
                    progress[i] = record ? record.fields.status : (i === 1 && !data.records.some(r => r.fields.userId === userId) ? 'current' : 'locked');
                }
                if (data.records.length === 0 || !data.records.some(r => r.fields.userId === userId) ) { // „É¶„Éº„Ç∂„Éº„ÅÆÈÄ≤Êçó„É¨„Ç≥„Éº„Éâ„Åå‰∏Ä„Å§„ÇÇ„Å™„ÅÑÂ†¥Âêà
                     progress[1] = 'current';
                     for (let i = 2; i <= TOTAL_STAGES; i++) progress[i] = 'locked';
                }
                return progress;
            } catch (error) {
                console.error('Failed to fetch user progress:', error);
                showLoading(false);
                // „Ç®„É©„ÉºÊôÇ„ÅØ„Éá„Éï„Ç©„É´„Éà„ÅÆÈÄ≤ÊçóÔºà„Çπ„ÉÜ„Éº„Ç∏1„ÅåcurrentÔºâ„ÇíËøî„Åô„Å™„Å©„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                const defaultProgress = {};
                for (let i = 1; i <= TOTAL_STAGES; i++) defaultProgress[i] = (i === 1 ? 'current' : 'locked');
                return defaultProgress;
            } finally {
                showLoading(false);
            }
            */
        }

        async function saveUserProgress(userId, stageId, newStatus) {
            showLoading(true);
            console.log(`Saving progress for userId: ${userId}, stageId: ${stageId}, status: ${newStatus}`);
            // --- „Çπ„Çø„ÉñÂÆüË£Ö ---
            // Adalo„Åß„ÅØ„ÄÅÁâπÂÆö„ÅÆÈÄ≤Êçó„É¨„Ç≥„Éº„Éâ„ÇíÊõ¥Êñ∞„Åô„Çã„Åã„ÄÅ„Å™„Åë„Çå„Å∞Êñ∞Ë¶è‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ
            // 1. userId„Å®stageId„ÅßÊó¢Â≠ò„É¨„Ç≥„Éº„Éâ„ÇíÊ§úÁ¥¢
            // 2. „ÅÇ„Çå„Å∞UPDATE (PATCH request to ${ADALO_API_ENDPOINT}/${recordId})
            // 3. „Å™„Åë„Çå„Å∞CREATE (POST request to ${ADALO_API_ENDPOINT})
            return new Promise(resolve => {
                setTimeout(() => {
                    userProgress[stageId] = newStatus;
                    console.log('Dummy progress saved:', userProgress);
                    showLoading(false);
                    resolve(true); // ‰øùÂ≠òÊàêÂäü
                }, 500);
            });
            // --- ÂÆüÈöõ„ÅÆfetch„ÅÆ‰æã ---
            /*
            try {
                // „Åæ„Åö„ÄÅuserId„Å®stageId„ÅßÊó¢Â≠ò„ÅÆÈÄ≤Êçó„É¨„Ç≥„Éº„Éâ„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç
                const searchResponse = await fetch(`${ADALO_API_ENDPOINT}?filter[userId]=${userId}&filter[stageId]=${stageId}`, {
                    method: 'GET',
                    headers: { 'Authorization': ADALO_API_KEY, 'Content-Type': 'application/json' }
                });
                const searchData = await searchResponse.json();
                const existingRecord = searchData.records.length > 0 ? searchData.records[0] : null;

                const payload = { fields: { userId: userId, stageId: parseInt(stageId), status: newStatus, Name: `User ${userId} - Stage ${stageId}` } }; // Adalo„ÅÆÂøÖÈ†à„Éï„Ç£„Éº„É´„ÉâName„Å™„Å©

                let response;
                if (existingRecord) { // Êõ¥Êñ∞
                    response = await fetch(`${ADALO_API_ENDPOINT}/${existingRecord.id}`, {
                        method: 'PUT', // „Åæ„Åü„ÅØ PATCH
                        headers: { 'Authorization': ADALO_API_KEY, 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else { // Êñ∞Ë¶è‰ΩúÊàê
                    response = await fetch(ADALO_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Authorization': ADALO_API_KEY, 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                userProgress[stageId] = newStatus; // „É≠„Éº„Ç´„É´„ÅÆÈÄ≤Êçó„ÇÇÊõ¥Êñ∞
                return true;
            } catch (error) {
                console.error('Failed to save user progress:', error);
                return false; // ‰øùÂ≠òÂ§±Êïó
            } finally {
                showLoading(false);
            }
            */
        }

        // --- ‰∏ª‰∫∫ÂÖ¨„É¨„Éô„É´Êõ¥Êñ∞ ---
        function updateHeroLevel() {
            const completedCount = Object.values(userProgress).filter(status => status === 'completed').length;
            if (completedCount >= 4) heroLevel = 3;
            else if (completedCount >= 2) heroLevel = 2;
            else heroLevel = 1;
        }

        // --- ÁîªÈù¢Ë°®Á§∫Êõ¥Êñ∞ ---
        function updateStageDisplay() {
            updateHeroLevel();
            let currentStageExists = false;

            for (let i = 1; i <= TOTAL_STAGES; i++) {
                const stageNode = document.getElementById(`stage-${i}`);
                if (!stageNode) continue;

                const status = userProgress[i] || 'locked';
                stageNode.classList.remove('completed', 'current', 'locked');
                stageNode.classList.add(status);

                // „Çπ„ÉÜ„Éº„Ç∏ÊÉÖÂ†±Ôºà„Çø„Ç§„Éà„É´„ÄÅË™¨ÊòéÔºâ„ÇíË®≠ÂÆö
                const staticInfo = stageStaticData[i];
                stageNode.querySelector('.stage-title').textContent = staticInfo.title;
                stageNode.querySelector('.stage-description').textContent = staticInfo.description;

                // „Ç¢„Ç§„Ç≥„É≥ÁîªÂÉè„Å®„ÇØ„É™„Ç¢„Ç®„Éï„Çß„ÇØ„ÉàÁîªÂÉè„ÇíË®≠ÂÆö
                const iconImg = stageNode.querySelector('.stage-icon img.icon-image');
                const fallbackSpan = stageNode.querySelector('.stage-icon .icon-fallback');
                if (iconImg) {
                    iconImg.src = staticInfo.iconImage;
                    iconImg.style.display = 'block'; // ÁîªÂÉè„Çí„Åæ„ÅöË°®Á§∫Ë©¶Ë°å
                    fallbackSpan.style.display = 'none'; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÅØÈö†„Åô
                }

                const clearEffectImg = stageNode.querySelector('.clear-effect');
                if (clearEffectImg) {
                    if (status === 'completed' && staticInfo.clearEffectImage) {
                        clearEffectImg.src = staticInfo.clearEffectImage;
                        clearEffectImg.style.display = 'block';
                    } else {
                        clearEffectImg.style.display = 'none';
                    }
                }
                
                const heroCharacter = stageNode.querySelector('.hero-character');
                if (heroCharacter) {
                    if (status === 'current') {
                        heroCharacter.style.display = 'block';
                        heroCharacter.querySelector('.hero-sprite').className = `hero-sprite hero-level-${heroLevel}`;
                        currentStageExists = true;
                    } else {
                        heroCharacter.style.display = 'none';
                    }
                }
            }
            
            // „ÄåÊ¨°„ÅÆÂÜíÈô∫„Å∏ÈÄ≤„ÇÄÔºÅ„Äç„Éú„Çø„É≥„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Å®ÊåôÂãï
            if (!currentStageExists && Object.values(userProgress).every(s => s === 'completed')) {
                mainQuestButton.textContent = 'üéâ ÂÖ®„Å¶„ÅÆÂÜíÈô∫„ÇíÈÅîÊàêÔºÅ';
                mainQuestButton.disabled = true;
            } else {
                mainQuestButton.textContent = 'üî• Ê¨°„ÅÆÂÜíÈô∫„Å∏ÈÄ≤„ÇÄÔºÅ';
                mainQuestButton.disabled = false;
            }
        }

        // --- „É¢„Éº„ÉÄ„É´Âá¶ÁêÜ ---
        function openStageModal(stageId) {
            const status = userProgress[stageId];
            if (status === 'locked') {
                alert('„Åì„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅØ„Åæ„Å†ÈñãÊîæ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºÅ');
                return;
            }
            currentStageIdForModal = stageId;
            const staticInfo = stageStaticData[stageId];
            modalStageTitle.textContent = `„Çπ„ÉÜ„Éº„Ç∏ ${stageId}: ${staticInfo.title}`;
            modalStageDescription.textContent = staticInfo.description;
            modalStageMessage.textContent = staticInfo.message;
            
            // „ÇØ„Ç®„Çπ„Éà„Å´Êåë„ÇÄ„Éú„Çø„É≥„ÅÆË°®Á§∫Âà∂Âæ°
            modalQuestBtn.style.display = (status === 'current') ? 'block' : 'none';

            stageModal.style.display = 'flex';
        }

        function closeStageModal() {
            stageModal.style.display = 'none';
            currentStageIdForModal = null;
        }

        // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---
        // „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº
        const hamburger = document.getElementById('hamburger');
        const sideNav = document.getElementById('sideNav');
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            sideNav.classList.toggle('active');
        });
        document.addEventListener('click', (e) => {
            if (sideNav.classList.contains('active') && !hamburger.contains(e.target) && !sideNav.contains(e.target)) {
                hamburger.classList.remove('active');
                sideNav.classList.remove('active');
            }
        });

        // „Çπ„ÉÜ„Éº„Ç∏„Éé„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØ
        document.querySelectorAll('.stage-node').forEach(node => {
            node.addEventListener('click', () => {
                const stageId = node.dataset.stageId;
                openStageModal(parseInt(stageId));
            });
        });

        // „É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã„Éú„Çø„É≥
        modalCloseBtn.addEventListener('click', closeStageModal);
        stageModal.addEventListener('click', (e) => { // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            if (e.target === stageModal) closeStageModal();
        });

        // „É¢„Éº„ÉÄ„É´ÂÜÖÂãïÁîª„ÇíË¶ã„Çã„Éú„Çø„É≥
        modalVideoBtn.addEventListener('click', () => {
            alert(`„Çπ„ÉÜ„Éº„Ç∏ ${currentStageIdForModal} „ÅÆÂãïÁîª„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇÔºàÂÆüË£Ö„ÅØÂà•ÈÄîÔºâ`);
        });

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÇØ„Ç®„Çπ„Éà„Å´Êåë„ÇÄ„Éú„Çø„É≥
        modalQuestBtn.addEventListener('click', async () => {
            if (!currentStageIdForModal || userProgress[currentStageIdForModal] !== 'current') return;

            const success = await saveUserProgress(currentUserId, currentStageIdForModal, 'completed');
            if (success) {
                userProgress[currentStageIdForModal] = 'completed'; // „É≠„Éº„Ç´„É´„ÇÇÊõ¥Êñ∞
                const nextStageId = currentStageIdForModal + 1;
                if (nextStageId <= TOTAL_STAGES) {
                    const nextSuccess = await saveUserProgress(currentUserId, nextStageId, 'current');
                    if (nextSuccess) {
                         userProgress[nextStageId] = 'current'; // „É≠„Éº„Ç´„É´„ÇÇÊõ¥Êñ∞
                    } else {
                        alert('Ê¨°„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅÆËß£Êîæ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                        // ÂøÖË¶Å„Å™„Çâ„É≠„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ
                    }
                }
                updateStageDisplay();
                closeStageModal();
                setTimeout(() => {
                    alert(`„Çπ„ÉÜ„Éº„Ç∏ ${currentStageIdForModal} „ÇØ„É™„Ç¢ÔºÅüéâ ${nextStageId <= TOTAL_STAGES ? 'Ê¨°„ÅÆÂÜíÈô∫„Å∏ÈÄ≤„ÇÇ„ÅÜÔºÅ' : 'ÂÖ®„Å¶„ÅÆÂÜíÈô∫„ÇíÈÅîÊàê„Åó„Åæ„Åó„ÅüÔºÅ'}`);
                }, 100);
            } else {
                alert('ÈÄ≤Êçó„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        });
        
        // „É°„Ç§„É≥„ÅÆ„ÄåÊ¨°„ÅÆÂÜíÈô∫„Å∏ÈÄ≤„ÇÄÔºÅ„Äç„Éú„Çø„É≥
        mainQuestButton.addEventListener('click', () => {
            const currentStageEntry = Object.entries(userProgress).find(([_, status]) => status === 'current');
            if (currentStageEntry) {
                openStageModal(parseInt(currentStageEntry[0]));
            } else if (Object.values(userProgress).every(s => s === 'completed')) {
                // ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà„Éú„Çø„É≥„Åådisabled„Å´„Å™„Å£„Å¶„ÅÑ„Çã„ÅØ„ÅöÔºâ
            } else {
                alert('ÂÜíÈô∫„ÇíÂßã„ÇÅ„ÇãÊ∫ñÂÇô„Åå„Åß„Åç„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        });

        // ÂÜíÈô∫„ÅÆË®òÈå≤„Éú„Çø„É≥
        document.getElementById('adventureLogBtn').addEventListener('click', () => {
            let logText = "üìñ „Åì„Çå„Åæ„Åß„ÅÆÂÜíÈô∫„ÅÆË®òÈå≤\n\n";
            let completedCount = 0;
            for (let i = 1; i <= TOTAL_STAGES; i++) {
                if (userProgress[i] === 'completed') {
                    logText += `„Çπ„ÉÜ„Éº„Ç∏${i}: ${stageStaticData[i].title} - „ÇØ„É™„Ç¢Ê∏à„Åø\n`;
                    completedCount++;
                } else if (userProgress[i] === 'current') {
                    logText += `„Çπ„ÉÜ„Éº„Ç∏${i}: ${stageStaticData[i].title} - ÊåëÊà¶‰∏≠\n`;
                }
            }
            if (completedCount === 0 && !Object.values(userProgress).some(s => s === 'current')) {
                logText += '„Åæ„Å†ÂÜíÈô∫„ÅØÂßã„Åæ„Å£„Åü„Å∞„Åã„Çä„Åß„ÅôÔºÅ';
            }
            logText += `\n‰∏ª‰∫∫ÂÖ¨„É¨„Éô„É´: ${heroLevel}`;
            alert(logText);
        });

        // --- ÂàùÊúüÂåñÂá¶ÁêÜ ---
        async function initializeApp() {
            currentUserId = getUserIdFromUrl();
            if (!currentUserId) {
                alert('„É¶„Éº„Ç∂„ÉºID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇAdalo„Åã„Çâ„ÅÆËµ∑Âãï„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                // „Åì„Åì„Åß„Éá„Éï„Ç©„É´„ÉàË°®Á§∫„Çí„Åô„Çã„Åã„ÄÅ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Åø„Å´„Åô„Çã„Åã„Å™„Å©Ê§úË®é
                // ‰ªÆ„Å´„ÄÅuserId„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÉÜ„Çπ„Éà„É¶„Éº„Ç∂„Éº„Å®„Åó„Å¶ÈÄ≤„ÇÅ„Çã
                currentUserId = 'testUser001'; 
                console.warn('User ID not found in URL, using default testUser001');
                // return; // userId„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂá¶ÁêÜ„Çí‰∏≠Êñ≠„Åô„ÇãÂ†¥Âêà
            }

            userProgress = await fetchUserProgress(currentUserId);
            updateStageDisplay();
        }

        // DOMË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´ÂÆüË°å
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
